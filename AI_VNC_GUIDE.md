# AI 操作 KVM VNC 指南

## 概述

本指南说明如何让 AI 通过前端界面的 KVM VNC 面板操作虚拟机。

## 架构说明

### 前端界面结构

```
frontend/index.html
├── KVM VNC 面板
│   ├── 控制按钮（启动、关闭、重启、强停）
│   ├── noVNC iframe（显示虚拟机界面）
│   └── 状态指示器
├── AI Agent 面板
│   ├── 快捷指令
│   ├── 聊天记录
│   └── 输入框
└── Terminal 面板
    └── 操作日志
```

### 工作原理

1. **noVNC iframe**：
   - 加载 `http://10.8.136.182:6080/vnc.html`
   - 显示虚拟机的图形界面
   - AI 可以通过浏览器工具操作 iframe

2. **AI 操作方式**：
   - AI 使用 MCP 浏览器服务
   - 可以访问并操作 iframe 中的元素
   - 可以模拟键盘和鼠标操作
   - 可以截图并分析界面

## 使用方法

### 1. 启动服务

```bash
# 启动后端服务
uv run python src/server.py

# 确保 VNC 服务运行
# 在 10.8.136.182 服务器上
# noVNC 运行在 http://10.8.136.182:6080
```

### 2. 打开前端界面

打开 `frontend/index.html`，界面会自动连接到后端服务。

### 3. 连接 KVM VNC

点击 "KVM VNC" 选项卡，系统会自动加载 noVNC iframe。

### 4. 使用 AI 操作

#### 方法 1: 使用快捷指令

点击右侧 AI Agent 面板的快捷按钮：
- **VNC 截图**：截图并分析 VNC 界面
- **进入 BIOS**：在 VNC 中按下 F2 键

#### 方法 2: 手动输入任务

在 AI Agent 输入框中输入任务描述。

## AI 操作示例

### 示例 1: 观察 VNC 界面

```
任务：截图 KVM VNC 界面并告诉我显示什么

AI 会：
1. 访问前端页面的 KVM VNC 面板
2. 截取 noVNC iframe 的内容
3. 分析屏幕上的内容
4. 告诉你当前显示的是什么（BIOS、UEFI、OS）
```

### 示例 2: 进入 BIOS 设置

```
任务：在 VNC 界面中按下 F2 键进入 BIOS

AI 会：
1. 确保 KVM VNC 面板已加载
2. 模拟按下 F2 键
3. 等待界面变化
4. 截图并描述 BIOS 设置内容
```

### 示例 3: 登录系统

```
任务：登录系统，用户名是 root

AI 会：
1. 观察 VNC 界面，找到登录提示
2. 输入用户名 "root"
3. 等待密码提示
4. 输入密码
5. 验证是否登录成功
```

### 示例 4: 执行命令

```
任务：在系统中执行 lscpu 命令

AI 会：
1. 确保已登录系统
2. 打开终端
3. 输入命令 "lscpu"
4. 截图并显示命令输出
```

### 示例 5: 控制虚拟机

```
任务：启动虚拟机 test-vm

AI 会：
1. 调用虚拟机控制 API
2. POST http://localhost:8082/vm/control
3. 请求体: {"action": "start", "vm_name": "test-vm"}
4. 观察 VNC 界面，等待虚拟机启动
5. 截图并描述启动过程
```

## 高级操作

### 自动化测试流程

```
任务：完成以下自动化测试

1. 启动虚拟机
2. 观察启动过程，记录每个阶段的时间
3. 进入 BIOS 设置，验证配置
4. 退出 BIOS，启动系统
5. 等待系统启动完成
6. 执行性能测试命令
7. 收集测试结果
8. 关闭虚拟机

请生成详细的测试报告。
```

### 多虚拟机管理

```
任务：管理多个虚拟机

1. 列出所有虚拟机状态
2. 对每个虚拟机执行健康检查
3. 截图记录每个虚拟机的状态
4. 生成状态报告
```

### 故障诊断

```
任务：诊断虚拟机问题

虚拟机无法启动，请帮我：

1. 检查虚拟机状态
2. 查看 VNC 界面显示的错误信息
3. 截图错误界面
4. 分析可能的原因
5. 提供解决方案
```

## 技术细节

### noVNC 配置

noVNC URL 格式：
```
http://10.8.136.182:6080/vnc.html?host=10.8.136.182&port=5900&password=admin
```

参数说明：
- `host`: VNC 服务器地址
- `port`: VNC 端口
- `password`: VNC 密码

### AI 操作工具

AI 可以使用以下工具：

1. **浏览器工具**：
   - `navigate_page`: 导航到页面
   - `take_screenshot`: 截图
   - `click`: 点击元素
   - `fill`: 填写表单
   - `evaluate_script`: 执行 JavaScript

2. **API 调用**：
   - `fetch`: 调用 REST API
   - 控制 VNC、启动/停止虚拟机等

### 状态监控

AI 可以：
- 监控 VNC 连接状态
- 获取虚拟机运行状态
- 检测系统事件
- 实时反馈操作结果

## 常见问题

### Q: AI 无法操作 VNC 界面

A: 确保：
1. noVNC 服务正常运行
2. 前端可以访问 noVNC URL
3. AI 已连接到后端服务
4. KVM VNC 面板已加载

### Q: 截图显示空白

A: 检查：
1. noVNC iframe 是否加载成功
2. VNC 连接是否建立
3. 虚拟机是否正在运行

### Q: 键盘操作无响应

A: 确保：
1. VNC 界面已获得焦点
2. 虚拟机正在运行
3. 键盘事件正确发送

## 最佳实践

1. **任务描述清晰**：提供详细的操作步骤
2. **分步执行**：将复杂任务分解为小步骤
3. **验证结果**：让 AI 截图验证每一步
4. **错误处理**：告诉 AI 如何处理错误
5. **记录日志**：所有操作都会记录在 Terminal 面板

## 示例任务库

### BIOS 操作
- 进入 BIOS 设置
- 修改启动顺序
- 保存并退出 BIOS
- 查看 BIOS 版本信息

### 系统操作
- 登录系统
- 执行命令
- 查看系统信息
- 安装软件

### 虚拟机管理
- 启动虚拟机
- 关闭虚拟机
- 重启虚拟机
- 查看虚拟机状态

### 测试验证
- 功能测试
- 性能测试
- 压力测试
- 兼容性测试

## 总结

通过 AI 操作 KVM VNC 系统，可以实现：
- 自动化测试
- 远程管理
- 批量操作
- 智能诊断
- 报告生成

AI 可以像人类一样操作虚拟机，但更快速、更准确、更可靠。