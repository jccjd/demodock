# MCP 浏览器自动化架构

## 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                      用户浏览器                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  browser_mcp_demo.html (用户界面)                    │  │
│  │  - 控制面板                                           │  │
│  │  - VNC 查看器                                         │  │
│  │  - 操作日志                                           │  │
│  └──────────────────┬───────────────────────────────────┘  │
│                     │ HTTP/JSON-RPC                         │
└─────────────────────┼───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────
│              FastAPI 代理服务器 (8082)                     
│  ┌──────────────────────────────────────────────────────
│  │  proxy_server_fastapi.py                            
│  │  - CORS 处理                                          
│  │  - 请求转发                                           
│  │  - 错误处理                                         
│  │  - 健康检查                                           
│  └──────────────────┬───────────────────────────────────
│                     │ HTTP/JSON-RPC                        
└─────────────────────┼───────────────────────────────────
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│           AIO Sandbox MCP 服务器 (8080)                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  MCP 协议处理器                                       │  │
│  │  - browser_navigate                                    │  │
│  │  - browser_screenshot                                  │  │
│  │  - browser_get_text                                    │  │
│  │  - browser_get_clickable_elements                      │  │
│  │  - browser_click                                       │  │
│  │  - browser_fill                                        │  │
│  └──────────────────┬───────────────────────────────────┘  │
│                     │                                       │
│  ┌──────────────────┴───────────────────────────────────┐  │
│  │  Playwright 浏览器自动化                              │  │
│  │  - 页面导航                                           │  │
│  │  - 元素交互                                           │  │
│  │  - 截图生成                                           │  │
│  └──────────────────┬───────────────────────────────────┘  │
│                     │                                       │
│  ┌──────────────────┴───────────────────────────────────┐  │
│  │  VNC 服务器 (5900)                                    │  │
│  │  - 实时浏览器视图                                      │  │
│  │  - noVNC Web 客户端                                   │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 组件说明

### 1. 用户界面 (browser_mcp_demo.html)
- **端口**: 3000 (通过本地 HTTP 服务器)
- **功能**:
  - 提供友好的用户界面
  - 发送 MCP JSON-RPC 请求
  - 显示操作日志和状态
  - 嵌入 VNC 查看器

### 2. FastAPI 代理服务器 (proxy_server_fastapi.py)
- **端口**: 8082
- **框架**: FastAPI + uvicorn
- **功能**:
  - **CORS 处理**: 允许跨域请求
  - **请求转发**: 将用户请求转发到 MCP 后端
  - **错误处理**: 统一的错误处理和响应格式
  - **健康检查**: `/health` 和 `/status` 端点

### 3. AIO Sandbox MCP 服务器
- **端口**: 8080 (HTTP API), 5900 (VNC)
- **协议**: MCP (Model Context Protocol)
- **功能**:
  - 浏览器自动化 (Playwright)
  - MCP 工具实现
  - VNC 远程桌面

## 数据流

### 请求流程
```
用户点击按钮
  ↓
浏览器发送 HTTP POST 到 FastAPI 代理
  ↓
FastAPI 添加 CORS 头并转发到 MCP
  ↓
MCP 执行浏览器操作
  ↓
MCP 返回 JSON-RPC 响应
  ↓
FastAPI 转发响应到浏览器
  ↓
浏览器更新 UI
```

### VNC 流程
```
浏览器加载 noVNC 页面
  ↓
WebSocket 连接到 VNC 服务器
  ↓
实时显示浏览器画面
```

## API 端点

### FastAPI 代理服务器
- `GET /` - 服务信息
- `GET /health` - 健康检查
- `GET /status` - 详细状态
- `POST /mcp` - MCP 请求代理

### AIO Sandbox MCP 服务器
- `POST /mcp` - MCP JSON-RPC API
- `GET /vnc/index.html` - VNC 查看器
- `GET /health` - 健康检查

## 启动命令

### 一键启动
```bash
./start_with_proxy.sh
```

### 手动启动
```bash
# 1. 启动 FastAPI 代理
python3 proxy_server_fastapi.py &

# 2. 启动本地 HTTP 服务器
python3 -m http.server 3000 &

# 3. 访问演示页面
# http://localhost:3000/browser_mcp_demo.html
```

## 为什么需要 FastAPI 代理?

1. **CORS 问题**: AIO Sandbox 没有配置 CORS,浏览器无法直接访问
2. **安全性**: 代理层可以添加认证、限流等安全措施
3. **灵活性**: 可以在代理层添加缓存、日志、监控等功能
4. **标准化**: FastAPI 提供标准的 REST API 接口

## 技术栈

- **前端**: HTML + CSS + JavaScript
- **代理**: FastAPI + uvicorn
- **后端**: AIO Sandbox + Playwright
- **协议**: MCP (Model Context Protocol)
- **远程桌面**: VNC + noVNC