<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIBE Studio - Full IDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; color: #334155; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #475569; }

        /* Markdown æ’ç‰ˆæ ·å¼ */
        .md-prose { font-size: 11px; line-height: 1.6; color: #334155; word-wrap: break-word; }
        .md-prose p { margin-bottom: 0.5rem; }
        .md-prose p:last-child { margin-bottom: 0; }
        .md-prose strong { font-weight: 600; color: #0f172a; }
        .md-prose ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 0.5rem; }
        .md-prose ol { list-style-type: decimal; padding-left: 1.25rem; margin-bottom: 0.5rem; }
        .md-prose li { margin-bottom: 0.25rem; }
        .md-prose code { font-family: 'JetBrains Mono', monospace; background-color: rgba(0,0,0,0.06); padding: 0.1rem 0.25rem; border-radius: 0.25rem; color: #db2777; font-size: 10px; }
        .md-prose pre { background-color: #f1f5f9; padding: 0.75rem; border-radius: 0.375rem; overflow-x: auto; margin-bottom: 0.5rem; border: 1px solid #e2e8f0; }
        .md-prose pre code { background-color: transparent; padding: 0; color: #334155; }
        
        /* æ­¥éª¤å¡ç‰‡æ‰‹é£ç´åŠ¨ç”» */
        .step-details {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out; opacity: 0;
        }
        .step-details.expanded { max-height: 1200px; opacity: 1; overflow-y: auto; }
        .rotate-icon { transition: transform 0.2s; }
        .expanded .rotate-icon { transform: rotate(180deg); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-[13px] bg-slate-50 antialiased">

    <!-- 1. é¡¶éƒ¨çŠ¶æ€æ  -->
    <header class="h-12 border-b border-slate-200 bg-white flex items-center justify-between px-4 shrink-0 z-20 shadow-sm">
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
                <div class="w-7 h-7 bg-blue-600 rounded-md flex items-center justify-center text-white font-bold text-sm shadow-inner">V</div>
                <span class="font-bold text-slate-800 tracking-tight">VIBE STUDIO</span>
            </div>
            <div class="flex items-center space-x-2 text-xs">
                <span class="text-slate-400">Task:</span>
                <span id="header-task-title" class="px-2 py-0.5 bg-slate-100 text-slate-700 rounded font-medium border border-slate-200 truncate max-w-md">cTDP Consistency Test</span>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 px-3 py-1 bg-slate-100 rounded border border-slate-200 shadow-inner">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span id="header-device-ip" class="text-[11px] text-slate-600 font-bold mono">Hygon 7002</span>
            </div>
            <button onclick="submitReport()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-[11px] font-bold shadow-sm hover:bg-blue-700 transition-colors">Submit Report</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- 2. å·¦ä¾§æµ‹è¯•æ­¥éª¤ Explorer -->
        <aside class="w-[340px] border-r border-slate-200 bg-white flex flex-col shrink-0 z-10 shadow-[2px_0_8px_rgba(0,0,0,0.02)]">
            <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                <span class="text-[11px] font-bold text-slate-700 uppercase tracking-widest flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    Execution Steps
                </span>
                <span id="step-count-badge" class="bg-slate-200 text-slate-600 text-[10px] px-1.5 py-0.5 rounded font-bold">4</span>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2.5 bg-slate-50/50" id="test-steps-container"></div>
        </aside>

        <!-- 3. ä¸­éƒ¨å·¥ä½œåŒº (VNC + Terminal) -->
        <main class="flex-1 flex flex-col min-w-[300px] bg-slate-200/80">
            <div class="h-10 flex items-end px-2 pt-2 space-x-1 shrink-0">
                <button id="tab-bios" onclick="switchTab('bios')" class="px-4 py-2 bg-white border border-b-0 border-slate-200 text-[11px] font-bold text-blue-600 rounded-t-lg shadow-sm flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                    KVM VNC
                </button>
                <button id="tab-bmc" onclick="switchTab('bmc')" class="px-4 py-2 bg-slate-100 text-[11px] font-medium text-slate-500 hover:bg-white rounded-t-lg transition-colors flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                    BMC Web
                </button>
            </div>
            <div class="flex-1 p-4 flex flex-col min-h-[40%]">
                <div class="flex-1 bg-[#0f111a] rounded-xl overflow-hidden border border-slate-800 shadow-2xl relative flex items-center justify-center">
                    <!-- BIOS Panel -->
                    <div id="bios-panel" class="w-full h-full flex flex-col bg-gradient-to-b from-slate-900 to-slate-800 relative">
                        <!-- VNC å¤´éƒ¨ä¿¡æ¯æ  -->
                        <div class="px-4 py-2 bg-slate-800/80 border-b border-slate-700 flex items-center justify-between shrink-0">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full" id="vnc-status-dot" style="background-color: #ef4444;"></div>
                                <span class="text-white text-xs font-medium">KVM VNC</span>
                                <span class="text-slate-400 text-[10px] mono" id="vnc-connection-info">localhost:6080 (websockify)</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <!-- è™šæ‹Ÿæœºæ§åˆ¶æŒ‰é’® -->
                                <button onclick="vmControl('start')" class="text-slate-400 hover:text-green-400 text-[10px] px-2 py-1 rounded hover:bg-slate-700 transition-colors flex items-center gap-1" title="å¯åŠ¨è™šæ‹Ÿæœº">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    å¯åŠ¨
                                </button>
                                <button onclick="vmControl('shutdown')" class="text-slate-400 hover:text-yellow-400 text-[10px] px-2 py-1 rounded hover:bg-slate-700 transition-colors flex items-center gap-1" title="å…³é—­è™šæ‹Ÿæœº">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
                                    å…³é—­
                                </button>
                                <button onclick="vmControl('reboot')" class="text-slate-400 hover:text-blue-400 text-[10px] px-2 py-1 rounded hover:bg-slate-700 transition-colors flex items-center gap-1" title="é‡å¯è™šæ‹Ÿæœº">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    é‡å¯
                                </button>
                                <button onclick="vmControl('stop')" class="text-slate-400 hover:text-red-400 text-[10px] px-2 py-1 rounded hover:bg-slate-700 transition-colors flex items-center gap-1" title="å¼ºåˆ¶åœæ­¢">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
                                    å¼ºåœ
                                </button>
                                <div class="w-px h-4 bg-slate-600 mx-1"></div>
                                <button onclick="reconnectVNC()" class="text-slate-400 hover:text-white text-[10px] px-2 py-1 rounded hover:bg-slate-700 transition-colors">
                                    é‡è¿
                                </button>
                            </div>
                        </div>
                        <!-- VNC å›¾åƒæ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="flex-1 relative flex items-center justify-center overflow-hidden bg-black">
                            <!-- è¿æ¥ä¸­/é”™è¯¯æç¤º -->
                            <div id="vnc-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/50 p-8 z-10">
                                <div class="w-12 h-12 mb-3 rounded-full bg-slate-700 flex items-center justify-center animate-pulse" id="vnc-icon-bg">
                                    <svg class="w-6 h-6 text-blue-400" id="vnc-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div class="text-white text-sm font-medium mb-1" id="vnc-status-text">æ­£åœ¨è¿æ¥...</div>
                                <div class="text-slate-400 text-xs text-center leading-relaxed max-w-md" id="vnc-status-detail">ç­‰å¾… VNC å›¾åƒæµ</div>
                            </div>
                            <!-- noVNC iframe -->
                            <iframe id="vnc-iframe" class="hidden w-full h-full border-0" allow="fullscreen"></iframe>
                        </div>
                    </div>
                    <!-- BMC iframe -->
                    <iframe id="bmc-frame" src="" class="w-full h-full border-0 absolute inset-0 z-10 hidden"></iframe>
                </div>
            </div>
            <!-- åº•éƒ¨ Terminal é¢æ¿ -->
            <div class="h-56 bg-[#1e1e2e] flex flex-col shrink-0 border-t border-slate-800 shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
                <div class="flex items-center justify-between px-4 bg-[#181825] h-8 shrink-0">
                    <span class="text-[#89b4fa] text-[10px] font-bold uppercase tracking-wider">System Output Logs</span>
                    <button onclick="clearLogs()" class="text-slate-500 hover:text-white text-[10px] uppercase tracking-wider font-bold transition-colors">Clear</button>
                </div>
                <div id="terminal-output" class="flex-1 overflow-y-auto p-3 terminal-scroll mono text-[12px] leading-relaxed"></div>
            </div>
        </main>

        <!-- 4. å³ä¾§ AI é€šä¿¡åŒº -->
        <aside class="w-96 border-l border-slate-200 bg-white flex flex-col shrink-0 shadow-xl z-10">
            <!-- å¤´éƒ¨çŠ¶æ€ -->
            <div class="px-4 py-3 bg-slate-800 flex items-center justify-between shrink-0">
                <div class="flex items-center space-x-2">
                    <div class="w-6 h-6 rounded bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    </div>
                    <span class="text-white font-bold text-sm tracking-wide">AI Agent Protocol</span>
                </div>
                <div class="flex items-center space-x-1.5 px-2 py-1 bg-black/30 rounded text-[10px]">
                    <span id="ws-dot" class="w-2 h-2 bg-slate-500 rounded-full"></span>
                    <span id="ws-text" class="text-slate-300">Offline</span>
                </div>
            </div>

            <!-- å¿«æ·æŒ‡ä»¤ -->
            <div class="px-4 py-2 bg-white border-b border-slate-100">
                <div class="text-[10px] text-slate-400 font-medium mb-2">Quick Commands:</div>
                <div class="flex flex-wrap gap-1.5">
                    <button onclick="quickCommand('å¸®æˆ‘æ‰“å¼€ç™¾åº¦æœç´¢äººå·¥æ™ºèƒ½')" class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-[10px] font-medium hover:bg-slate-200 transition-colors">æœç´¢</button>
                    <button onclick="quickCommand('åˆ—å‡ºå½“å‰å·¥ä½œç›®å½•çš„æ–‡ä»¶')" class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-[10px] font-medium hover:bg-slate-200 transition-colors">åˆ—æ–‡ä»¶</button>
                    <button onclick="quickCommand('å¸®æˆ‘åˆ†æä»£ç ç»“æ„')" class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-[10px] font-medium hover:bg-slate-200 transition-colors">åˆ†æä»£ç </button>
                </div>
            </div>

            <!-- èŠå¤©è®°å½•å®¹å™¨ -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-slate-50/50">
                <div class="text-center text-[10px] text-slate-400 my-2">Waiting for server connection...</div>
            </div>

            <!-- è¾“å…¥åŒº -->
            <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                <div class="relative flex items-end border border-slate-300 rounded-lg focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-100 transition-all bg-slate-50">
                    <textarea id="chat-input" rows="2" placeholder="Send instruction... (Ctrl+Enter)" class="w-full bg-transparent py-2.5 pl-3 pr-10 text-xs outline-none resize-none disabled:opacity-50" disabled></textarea>
                    <button id="send-btn" onclick="sendMessage()" class="absolute right-2 bottom-2 p-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-slate-300 transition-colors" disabled>
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- ========================================== -->
    <!-- ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘å¼•æ“ -->
    <!-- ========================================== -->
    <script>
        // é…ç½®ä¸­å¿ƒ
        const HOST = window.location.hostname || 'localhost';
        const AppConfig = {
            WS_URL: `ws://${HOST}:8082/ws`,
            HEALTH_URL: `http://${HOST}:8082/health`,
            VNC_BMC_URL: `http://10.8.135.251:3000/vnc/index.html?autoconnect=true`,
            VNC_WS_URL: `ws://${HOST}:8082/vnc`,
            VNC_WEBSOCKIFY_URL: `ws://${HOST}:6080/websockify`,  // websockify WebSocket åœ°å€ï¼ˆæœ¬åœ°ï¼‰
            VNC_NOVNC_URL: `novnc/vnc_lite.html?host=${HOST}&port=6080&path=websockify`,  // noVNC é¡µé¢ï¼ˆå¸¦å‚æ•°ï¼‰
            BIOS_VNC_ADDR: `${HOST}:5900`
        };

        // åˆå§‹åŒ– marked é€‰é¡¹
        marked.setOptions({ gfm: true, breaks: true });

        // æµ‹è¯•æ­¥éª¤æ•°æ®
        const testSteps = [
            {
                step_id: 1,
                step_number: 1,
                description: "è¿›å…¥ BIOS Setupï¼Œå¯¼èˆªè‡³ä»¥ä¸‹è·¯å¾„ï¼š\n\n**CBS â†’ NBIO â†’ cTDP Control**\n\nå°†æ¨¡å¼è®¾ç½®ä¸º `Manual`ï¼Œç›®æ ‡åŠŸç‡è®¾ç½®ä¸º `280W`ã€‚",
                expected_result: "cTDP é…ç½®æˆåŠŸä¿å­˜ï¼Œé‡å¯åç”Ÿæ•ˆ",
                actual_result: "",
                status: "1" // Running
            },
            {
                step_id: 2,
                step_number: 2,
                description: "é€šè¿‡ BMC Web ç•Œé¢æ£€æŸ¥ç³»ç»Ÿäº‹ä»¶æ—¥å¿—ï¼š\n\n1. ç™»å½• BMC Web æ§åˆ¶å°\n2. å¯¼èˆªè‡³ **Server Health â†’ Event Log**\n3. ç¡®è®¤æ— ç¡¬ä»¶å‘Šè­¦",
                expected_result: "æ—  Critical æˆ– Warning çº§åˆ«äº‹ä»¶",
                actual_result: "",
                status: "0" // Waiting
            },
            {
                step_id: 3,
                step_number: 3,
                description: "åœ¨ OS ä¸‹æ‰§è¡Œå‹åŠ›æµ‹è¯•ï¼š\n\n```bash\nstress-ng --cpu 64 --timeout 3600s\n```\n\nç›‘æ§ CPU é¢‘ç‡å’ŒåŠŸè€—å˜åŒ–ã€‚",
                expected_result: "CPU é¢‘ç‡ç¨³å®šï¼ŒåŠŸè€—æ¥è¿‘ cTDP è®¾å®šå€¼",
                actual_result: "",
                status: "0"
            },
            {
                step_id: 4,
                step_number: 4,
                description: "éªŒè¯ç³»ç»Ÿæ‹“æ‰‘ç»“æ„ï¼š\n\n```bash\nlscpu\nlstopo\n```\n\nç¡®è®¤ NUMA èŠ‚ç‚¹å’Œ CPU æ‹“æ‰‘æ­£ç¡®ã€‚",
                expected_result: "æ‹“æ‰‘ç»“æ„ä¸é¢„æœŸä¸€è‡´",
                actual_result: "",
                status: "0"
            }
        ];

        // WebSocket ç›¸å…³å˜é‡
        let ws = null;
        let isConnected = false;
        let vncWs = null;
        let vncConnected = false;

        // DOM å…ƒç´ å¼•ç”¨
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const terminalOutput = document.getElementById('terminal-output');
        const vncIframe = document.getElementById('vnc-iframe');
        const vncPlaceholder = document.getElementById('vnc-placeholder');
        const vncStatusDot = document.getElementById('vnc-status-dot');
        const vncStatusText = document.getElementById('vnc-status-text');
        const vncStatusDetail = document.getElementById('vnc-status-detail');
        const vncIconBg = document.getElementById('vnc-icon-bg');
        const vncIcon = document.getElementById('vnc-icon');

        // ==========================================
        // Tab åˆ‡æ¢
        // ==========================================
        function switchTab(tabId) {
            const tabBios = document.getElementById('tab-bios');
            const tabBmc = document.getElementById('tab-bmc');
            const biosPanel = document.getElementById('bios-panel');
            const bmcFrame = document.getElementById('bmc-frame');

            const activeCls = "px-4 py-2 bg-white border border-b-0 border-slate-200 text-[11px] font-bold text-blue-600 rounded-t-lg shadow-sm flex items-center gap-2";
            const inactiveCls = "px-4 py-2 bg-slate-100 text-[11px] font-medium text-slate-500 hover:bg-white rounded-t-lg transition-colors flex items-center gap-2";

            if (tabId === 'bios') {
                tabBios.className = activeCls;
                tabBmc.className = inactiveCls;
                biosPanel.classList.remove('hidden');
                bmcFrame.classList.add('hidden');
                addLog('info', 'Switched to BIOS Console');
                // è¿æ¥ VNC
                if (!vncConnected) {
                    connectVNC();
                }
            } else {
                tabBmc.className = activeCls;
                tabBios.className = inactiveCls;
                biosPanel.classList.add('hidden');
                bmcFrame.classList.remove('hidden');
                if (!bmcFrame.src || bmcFrame.src === '' || bmcFrame.src === window.location.href) {
                    bmcFrame.src = AppConfig.VNC_BMC_URL;
                }
                addLog('info', 'Switched to BMC Web Console');
            }
        }

        // ==========================================
        // æµ‹è¯•æ­¥éª¤ç®¡ç† (æ‰‹é£ç´å¼)
        // ==========================================
        function renderTestSteps() {
            const container = document.getElementById('test-steps-container');
            container.innerHTML = '';
            
            const statusMap = {
                "0": { text: "Waiting", border: "border-slate-200", bg: "bg-white", badge: "bg-slate-100 text-slate-500", icon: "â³" },
                "1": { text: "Running", border: "border-blue-400", bg: "bg-blue-50/50", badge: "bg-blue-100 text-blue-700", icon: "ğŸ”„" },
                "2": { text: "Failed", border: "border-red-300", bg: "bg-red-50/50", badge: "bg-red-100 text-red-700", icon: "âŒ" },
                "3": { text: "Pass", border: "border-emerald-300", bg: "bg-emerald-50/30", badge: "bg-emerald-100 text-emerald-700", icon: "âœ…" }
            };

            testSteps.forEach((step, index) => {
                const statusObj = statusMap[step.status] || statusMap["0"];
                const htmlDesc = marked.parse(step.description || 'æ— æè¿°');
                const htmlExpected = marked.parse(step.expected_result || 'æ— é¢„æœŸç»“æœ');
                const htmlActual = step.actual_result ? marked.parse(step.actual_result) : null;
                const isExpanded = step.status === "1" ? 'expanded' : '';
                const hasShadow = step.status === "1" ? 'shadow-md' : '';

                container.innerHTML += `
                    <div class="mb-3 rounded-lg border ${statusObj.border} ${statusObj.bg} transition-shadow duration-300 ${hasShadow} bg-white">
                        <div class="px-3 py-2.5 cursor-pointer flex flex-col gap-1.5 select-none" onclick="toggleStep(this)">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-[12px] text-slate-800 flex items-center gap-1.5">
                                    <span>${statusObj.icon}</span> 
                                    Step ${step.step_number}
                                </span>
                                <div class="flex items-center gap-2">
                                    <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${statusObj.badge}">${statusObj.text}</span>
                                    <svg class="w-4 h-4 text-slate-400 rotate-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                            <div class="text-[11px] text-slate-500 truncate pr-6">${step.description.split('\n')[0].substring(0, 50)}...</div>
                        </div>
                        <div class="step-details ${isExpanded} border-t border-slate-100/80 bg-slate-50/30 rounded-b-lg custom-scrollbar">
                            <div class="p-4 flex flex-col gap-4">
                                <div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                                        Description
                                    </div>
                                    <div class="md-prose">${htmlDesc}</div>
                                </div>
                                <div class="pt-3 border-t border-slate-200 border-dashed">
                                    <div class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1.5 flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        Expected
                                    </div>
                                    <div class="md-prose">${htmlExpected}</div>
                                </div>
                                ${htmlActual ? `
                                <div class="pt-3 border-t border-slate-200 border-dashed">
                                    <div class="text-[10px] font-bold ${step.status === '2' ? 'text-red-500' : 'text-emerald-500'} uppercase tracking-wider mb-1.5">Actual Result</div>
                                    <div class="md-prose ${step.status === '2' ? 'text-red-700 bg-red-50/50 p-2 rounded border border-red-100' : ''}">${htmlActual}</div>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        }

        function toggleStep(element) {
            const detailsDiv = element.nextElementSibling;
            const wrapperDiv = element.parentElement;
            if (detailsDiv.classList.contains('expanded')) {
                detailsDiv.classList.remove('expanded');
                wrapperDiv.classList.remove('shadow-md');
            } else {
                document.querySelectorAll('.step-details.expanded').forEach(el => {
                    el.classList.remove('expanded');
                    el.parentElement.classList.remove('shadow-md');
                });
                detailsDiv.classList.add('expanded');
                wrapperDiv.classList.add('shadow-md');
            }
        }

        // ==========================================
        // Terminal æ—¥å¿—
        // ==========================================
        function addLog(type, message) {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const div = document.createElement('div');
            div.className = 'flex space-x-3 mb-1 hover:bg-white/5 px-1 rounded';
            let color = type === 'error' ? 'text-[#ef5350]' : (type === 'success' ? 'text-[#addb67]' : (type === 'cmd' ? 'text-[#82aaff]' : 'text-[#a6accd]'));
            let prefix = type === 'error' ? '[ERROR]' : (type === 'success' ? '[SUCCESS]' : (type === 'cmd' ? '[EXEC]' : '[INFO]'));
            div.innerHTML = `<span class="text-[#4d5566] shrink-0">[${time}]</span> <span class="${color} shrink-0">${prefix}</span> <span class="text-[#a6accd] whitespace-pre-wrap break-words">${escapeHtml(message)}</span>`;
            terminalOutput.appendChild(div);
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        function clearLogs() {
            terminalOutput.innerHTML = '';
            addLog('info', 'Logs cleared');
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        // ==========================================
        // WebSocket é€šä¿¡
        // ==========================================
        async function connectWebSocket() {
            // å…ˆæ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
            try {
                const response = await fetch(AppConfig.HEALTH_URL, { method: 'GET' });
                if (!response.ok) {
                    showServiceDependencyInfo();
                    setTimeout(connectWebSocket, 5000);
                    return;
                }
            } catch (e) {
                showServiceDependencyInfo();
                setTimeout(connectWebSocket, 5000);
                return;
            }

            updateStatus('connecting');
            addLog('info', `Connecting to ${AppConfig.WS_URL}...`);

            try {
                ws = new WebSocket(AppConfig.WS_URL);
                
                ws.onopen = () => {
                    isConnected = true;
                    updateStatus('connected');
                    chatMessages.innerHTML = '';
                    addMessage('system', 'âœ… Connected to iFlow Browser Server');
                    addLog('success', 'WebSocket connected');
                };

                ws.onmessage = (e) => {
                    console.log('WebSocket raw message:', e.data);
                    try {
                        const data = JSON.parse(e.data);
                        console.log('Parsed message type:', data.type, 'data:', data);
                        handleMessage(data);
                    } catch (err) {
                        console.log('Non-JSON message:', e.data);
                        addMessage('ai', e.data);
                    }
                };

                ws.onclose = () => {
                    isConnected = false;
                    updateStatus('offline');
                    addMessage('system', 'âš ï¸ Connection closed');
                    addLog('info', 'WebSocket disconnected, reconnecting...');
                    setTimeout(connectWebSocket, 5000);
                };

                ws.onerror = () => {
                    updateStatus('offline');
                    addLog('error', 'WebSocket error');
                };

            } catch (err) {
                updateStatus('offline');
                addLog('error', 'Connection failed: ' + err.message);
                setTimeout(connectWebSocket, 5000);
            }
        }

        function updateStatus(state) {
            const dot = document.getElementById('ws-dot');
            const text = document.getElementById('ws-text');

            if (state === 'connected') {
                dot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]';
                text.textContent = 'Connected';
                chatInput.disabled = sendBtn.disabled = false;
            } else if (state === 'connecting') {
                dot.className = 'w-2 h-2 bg-yellow-500 rounded-full';
                text.textContent = 'Connecting...';
            } else {
                dot.className = 'w-2 h-2 bg-red-500 rounded-full';
                text.textContent = 'Offline';
                chatInput.disabled = sendBtn.disabled = true;
            }
        }

// VNC è¿æ¥å’Œå›¾åƒå¤„ç†

function connectVNC() {
            if (vncConnected) {
                return;
            }

            updateVNCStatus('connecting', 'æ­£åœ¨è¿æ¥...', 'æ­£åœ¨åŠ è½½ noVNC å¹¶è¿æ¥ websockify');
            addLog('info', `Loading noVNC: ${AppConfig.VNC_NOVNC_URL}`);

            try {
                // ä½¿ç”¨ noVNC iframeï¼Œå®ƒä¼šè‡ªåŠ¨è¿æ¥åˆ° websockify
                vncIframe.src = AppConfig.VNC_NOVNC_URL;
                vncIframe.classList.remove('hidden');
                vncPlaceholder.classList.add('hidden');

                // ç›‘å¬ iframe åŠ è½½å®Œæˆ
                vncIframe.onload = () => {
                    vncConnected = true;
                    updateVNCStatus('connected', 'å·²è¿æ¥', 'noVNC å·²åŠ è½½ï¼Œè¿æ¥åˆ° websockify');
                    addLog('success', 'VNC connected via noVNC + websockify');
                };

                // ç›‘å¬ iframe é”™è¯¯
                vncIframe.onerror = () => {
                    updateVNCStatus('error', 'è¿æ¥å¤±è´¥', 'noVNC åŠ è½½å¤±è´¥');
                    addLog('error', 'VNC iframe load failed');
                };

            } catch (err) {
                updateVNCStatus('error', 'è¿æ¥å¤±è´¥', err.message);
                addLog('error', 'VNC connection failed: ' + err.message);
            }
        }

        function updateVNCStatus(status, text, detail) {
            vncStatusText.textContent = text;

            // å¤„ç†å¤šè¡Œé”™è¯¯ä¿¡æ¯
            if (detail && detail.includes('\n')) {
                // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º HTML æ¢è¡Œ
                vncStatusDetail.innerHTML = detail.replace(/\n/g, '<br>');
            } else {
                vncStatusDetail.textContent = detail || '';
            }

            // é‡ç½®åŠ¨ç”»
            vncIconBg.classList.remove('animate-pulse');

            switch (status) {
                case 'connected':
                    vncStatusDot.style.backgroundColor = '#22c55e';
                    vncStatusDot.classList.add('animate-pulse');
                    vncIconBg.style.backgroundColor = '#16a34a';
                    vncIcon.style.color = '#ffffff';
                    break;
                case 'connecting':
                    vncStatusDot.style.backgroundColor = '#eab308';
                    vncStatusDot.classList.add('animate-pulse');
                    vncIconBg.style.backgroundColor = '#eab308';
                    vncIcon.style.color = '#ffffff';
                    vncIconBg.classList.add('animate-pulse');
                    break;
                case 'disconnected':
                    vncStatusDot.style.backgroundColor = '#64748b';
                    vncStatusDot.classList.remove('animate-pulse');
                    vncIconBg.style.backgroundColor = '#64748b';
                    vncIcon.style.color = '#ffffff';
                    break;
                case 'error':
                    vncStatusDot.style.backgroundColor = '#ef4444';
                    vncStatusDot.classList.remove('animate-pulse');
                    vncIconBg.style.backgroundColor = '#ef4444';
                    vncIcon.style.color = '#ffffff';
                    // æ˜¾ç¤ºå ä½ç¬¦ï¼Œéšè— iframe
                    vncIframe.classList.add('hidden');
                    vncPlaceholder.classList.remove('hidden');
                    break;
                default:
                    vncStatusDot.style.backgroundColor = '#ef4444';
                    vncStatusDot.classList.remove('animate-pulse');
                    vncIconBg.style.backgroundColor = '#ef4444';
                    vncIcon.style.color = '#ffffff';
            }
        }

function reconnectVNC() {
            vncConnected = false;
            vncIframe.src = '';
            vncIframe.classList.add('hidden');
            vncPlaceholder.classList.remove('hidden');
            connectVNC();
        }

        // ==========================================
        // è™šæ‹Ÿæœºæ§åˆ¶
        // ==========================================
        async function vmControl(action) {
            const vmName = prompt('è¯·è¾“å…¥è™šæ‹Ÿæœºåç§°:', 'test-vm');
            if (!vmName) return;

            addLog('info', `æ­£åœ¨${action}è™šæ‹Ÿæœº: ${vmName}`);

            try {
                const response = await fetch(`http://${HOST}:8082/vm/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        vm_name: vmName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    addLog('success', result.output);
                    if (result.state) {
                        addLog('info', `è™šæ‹ŸæœºçŠ¶æ€: ${result.state}`);
                    }
                } else {
                    addLog('error', result.output || 'æ“ä½œå¤±è´¥');
                }

            } catch (error) {
                addLog('error', `è™šæ‹Ÿæœºæ§åˆ¶å¤±è´¥: ${error.message}`);
            }
        }

        function showServiceDependencyInfo() {
            chatMessages.innerHTML = `
                <div class="space-y-2 text-xs">
                    <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">ğŸ“‹ æœåŠ¡ä¾èµ–</div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 space-y-2">
                        <div class="text-slate-600">
                            <div class="font-medium mb-1">éœ€è¦å¯åŠ¨ä»¥ä¸‹æœåŠ¡ï¼š</div>
                            <div class="font-mono text-[10px] space-y-1 ml-2">
                                <div class="text-slate-500">1. iFlow ACP Server:</div>
                                <div class="text-blue-600 bg-blue-50 px-2 py-1 rounded">iflow --experimental-acp --port 8090</div>
                                <div class="text-slate-500 mt-2">2. Browser Server:</div>
                                <div class="text-blue-600 bg-blue-50 px-2 py-1 rounded">uv run python src/server.py</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function handleMessage(data) {
            console.log('Received message:', data);
            
            if (data.type === 'tool_use' || data.type === 'tool_call') {
                // å·¥å…·è°ƒç”¨å‰ï¼Œå…ˆç»“æŸå½“å‰çš„æµå¼æ¶ˆæ¯
                finishCurrentStreamMessage();
                
                // å·¥å…·è°ƒç”¨æ¶ˆæ¯
                const toolName = data.tool || data.tool_name || 'unknown';
                const toolArgs = data.args || data.arguments || {};
                const toolStatus = data.status || 'pending';
                const toolId = data.id || `${toolName}-${Date.now()}`;
                
                // æ ¼å¼åŒ–å‚æ•°æ˜¾ç¤º
                let argsDisplay = '';
                if (Object.keys(toolArgs).length > 0) {
                    argsDisplay = JSON.stringify(toolArgs, null, 2);
                } else {
                    argsDisplay = '(no arguments)';
                }
                
                // çŠ¶æ€å›¾æ ‡
                let statusIcon = 'ğŸ”„';
                let statusColor = 'text-blue-600';
                if (toolStatus === 'completed') {
                    statusIcon = 'âœ…';
                    statusColor = 'text-green-600';
                } else if (toolStatus === 'error') {
                    statusIcon = 'âŒ';
                    statusColor = 'text-red-600';
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯
                const existingMsg = toolCallMessages[toolId];
                if (existingMsg) {
                    // æ›´æ–°ç°æœ‰æ¶ˆæ¯
                    const contentDiv = existingMsg.querySelector('.tool-content');
                    if (contentDiv) {
                        contentDiv.innerHTML = `
                            <div class="font-bold ${statusColor}">${statusIcon} ${toolName}</div>
                            <div class="text-[10px] text-slate-400 mt-1">çŠ¶æ€: ${toolStatus}</div>
                            <pre class="text-[9px] bg-slate-100 p-1.5 rounded mt-1 overflow-x-auto">${escapeHtml(argsDisplay)}</pre>
                        `;
                    }
                } else {
                    // åˆ›å»ºæ–°çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯
                    const div = document.createElement('div');
                    div.className = 'flex justify-start w-full';
                    div.innerHTML = `
                        <div class="flex flex-col max-w-[90%]">
                            <div class="bg-slate-100 border-slate-200 text-slate-600 border p-3 rounded-xl shadow-sm text-xs leading-relaxed">
                                <div class="tool-content">
                                    <div class="font-bold ${statusColor}">${statusIcon} ${toolName}</div>
                                    <div class="text-[10px] text-slate-400 mt-1">çŠ¶æ€: ${toolStatus}</div>
                                    <pre class="text-[9px] bg-slate-100 p-1.5 rounded mt-1 overflow-x-auto">${escapeHtml(argsDisplay)}</pre>
                                </div>
                            </div>
                        </div>`;
                    chatMessages.appendChild(div);
                    toolCallMessages[toolId] = div;
                }
                
                addLog('cmd', `Tool: ${toolName} - ${toolStatus}`);
                
                // åŒæ—¶åœ¨å·¦ä¾§æ­¥éª¤é¢æ¿æ˜¾ç¤ºå·¥å…·è°ƒç”¨
                addToolCallToPanel(toolName, toolArgs, toolStatus);
                
            } else if (data.type === 'task_finish') {
                // ä½¿ç”¨ task_finish çš„ full_response ç¡®ä¿æ¶ˆæ¯å®Œæ•´
                const finalContent = data.full_response || '';
                if (finalContent) {
                    // ç¡®ä¿æœ€ç»ˆæ¶ˆæ¯å†…å®¹å®Œæ•´
                    updateOrCreateAIMessage(finalContent, null, false);
                }
                
                // é‡ç½®æµå¼çŠ¶æ€
                isStreaming = false;
                accumulatedThought = '';  // é‡ç½®ç´¯ç§¯çš„æ€è€ƒå†…å®¹
                
                // æ¸…ç†å·¥å…·è°ƒç”¨è·Ÿè¸ª
                toolCallMessages = {};
                
                // å»¶è¿Ÿç§»é™¤ streaming-message classï¼Œç¡®ä¿å†…å®¹å·²æ›´æ–°
                setTimeout(() => {
                    const streamingMsg = chatMessages.querySelector('.streaming-message');
                    if (streamingMsg) {
                        streamingMsg.classList.remove('streaming-message');
                    }
                }, 100);
                
                addLog('success', 'Task finished: ' + (data.stop_reason || 'completed'));
                // æ ‡è®°å½“å‰æ­¥éª¤å®Œæˆ
                advanceStep();
                
            } else if (data.type === 'assistant' || data.type === 'stream' || data.status === 'streaming') {
                // å¤„ç†æµå¼å“åº”
                const content = data.full_response || data.chunk || data.content || '';
                const thought = data.thought || null;
                const isThoughtMessage = data.subtype === 'thought';  // çº¯æ€è€ƒæ¶ˆæ¯
                console.log('Stream content:', content, 'chunk:', data.chunk, 'full:', data.full_response, 'thought:', thought, 'isThought:', isThoughtMessage);
                
                // å¦‚æœæœ‰å†…å®¹ã€æœ‰æ€è€ƒã€æˆ–è€… chunk å­—æ®µå­˜åœ¨ï¼Œéƒ½æ›´æ–°æ¶ˆæ¯
                // æ³¨æ„ï¼šçº¯æ€è€ƒæ¶ˆæ¯æ—¶ content å¯èƒ½ä¸ºç©ºï¼Œä½† thought æœ‰å€¼
                if (content || thought || data.chunk !== undefined) {
                    updateOrCreateAIMessage(content, thought, isThoughtMessage);
                }
                
            } else if (data.type === 'plan') {
                // è®¡åˆ’æ¶ˆæ¯
                if (data.entries && data.entries.length > 0) {
                    const planText = data.entries.map((e, i) => `${i + 1}. ${e.content || e}`).join('\n');
                    addMessage('system', 'ğŸ“‹ Plan:\n' + planText);
                }
                
            } else if (data.chunk || data.full_response) {
                // å…¼å®¹å…¶ä»–æ ¼å¼çš„æµå¼å“åº”
                updateOrCreateAIMessage(data.full_response || data.chunk);
                
            } else if (data.content || data.message) {
                addMessage('ai', data.content || data.message);
                
            } else if (data.type === 'error') {
                addMessage('system', 'âŒ Error: ' + (data.error || data.message || 'Unknown error'));
                addLog('error', data.error || data.message || 'Unknown error');
            }
        }
        
        // åœ¨å·¦ä¾§é¢æ¿æ·»åŠ å·¥å…·è°ƒç”¨æ˜¾ç¤º
        function addToolCallToPanel(toolName, args, status) {
            const container = document.getElementById('test-steps-container');
            const toolDiv = document.createElement('div');
            toolDiv.className = 'mb-2 p-2 bg-blue-50 border border-blue-200 rounded text-[10px]';
            
            const statusIcon = status === 'completed' ? 'âœ…' : (status === 'error' ? 'âŒ' : 'ğŸ”„');
            const argsStr = Object.keys(args).length > 0 ? JSON.stringify(args) : '{}';
            
            toolDiv.innerHTML = `
                <div class="font-bold text-blue-700">${statusIcon} ${toolName}</div>
                <div class="text-slate-500 mono text-[9px] mt-1 truncate">${escapeHtml(argsStr)}</div>
            `;
            
            container.insertBefore(toolDiv, container.firstChild);
        }

        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !isConnected) return;
            
            addMessage('user', text);
            chatInput.value = '';
            addLog('info', `User: ${text}`);
            
            try {
                ws.send(text);
            } catch (e) {
                addMessage('system', 'Failed to send message');
            }
        }

        function quickCommand(cmd) {
            chatInput.value = cmd;
            sendMessage();
        }

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            
            let innerHTML = '';
            if (role === 'user') {
                innerHTML = `<div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-sm shadow-md text-xs leading-relaxed max-w-[85%] whitespace-pre-wrap">${escapeHtml(content)}</div>`;
            } else if (role === 'system') {
                innerHTML = `<div class="w-full text-center my-1"><span class="text-[10px] text-slate-400 bg-white/50 border border-slate-200 px-3 py-1 rounded-full shadow-sm">${escapeHtml(content)}</span></div>`;
            } else if (role === 'tool') {
                const parsedHtml = marked.parse(content);
                innerHTML = `
                    <div class="flex flex-col max-w-[90%]">
                        <div class="bg-slate-100 border-slate-200 text-slate-600 border p-3 rounded-xl shadow-sm text-xs leading-relaxed">
                            <div class="md-prose">${parsedHtml}</div>
                        </div>
                    </div>`;
            } else {
                const parsedHtml = marked.parse(content);
                innerHTML = `
                    <div class="flex flex-col max-w-[90%]">
                        <span class="text-[10px] font-bold text-slate-400 ml-1 mb-1">AI Agent</span>
                        <div class="bg-white border-slate-200 text-slate-700 border p-3 rounded-2xl rounded-tl-sm shadow-sm text-xs leading-relaxed">
                            <div class="md-prose">${parsedHtml}</div>
                        </div>
                    </div>`;
            }

            div.innerHTML = innerHTML;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æµå¼æ¶ˆæ¯å¤„ç†ï¼šæ›´æ–°æˆ–åˆ›å»º AI æ¶ˆæ¯
        let isStreaming = false;
        
        // å­˜å‚¨ç´¯ç§¯çš„æ€è€ƒå†…å®¹
        let accumulatedThought = '';
        
        // å·¥å…·è°ƒç”¨è·Ÿè¸ªï¼šç”¨äºæ›´æ–°å·¥å…·çŠ¶æ€è€Œéåˆ›å»ºæ–°æ¶ˆæ¯
        let currentToolCallId = null;
        let toolCallMessages = {};  // å­˜å‚¨å·¥å…·è°ƒç”¨æ¶ˆæ¯çš„å¼•ç”¨
        
        // ç”¨äºè·Ÿè¸ªå½“å‰æµå¼æ¶ˆæ¯çš„æœ¬åœ°å†…å®¹ï¼ˆä¸ä¾èµ–åç«¯çš„ full_responseï¼‰
        let currentStreamContent = '';
        
        function updateOrCreateAIMessage(content, thought, isThoughtMessage = false) {
            console.log('=== updateOrCreateAIMessage START ===');
            console.log('content:', content ? `"${content.substring(0, 100)}..." (${content.length} chars)` : '(empty)');
            console.log('thought:', thought ? `"${thought.substring(0, 50)}..."` : '(none)');
            console.log('isThoughtMessage:', isThoughtMessage);
            console.log('isStreaming:', isStreaming);
            
            // æŸ¥æ‰¾æœ€åä¸€æ¡æ­£åœ¨æµå¼ä¼ è¾“çš„ AI æ¶ˆæ¯
            const streamingMsg = chatMessages.querySelector('.streaming-message');
            console.log('Found streamingMsg:', !!streamingMsg);
            
            // æ„å»ºæ˜¾ç¤ºå†…å®¹ - ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„ contentï¼ˆåç«¯ä¼ æ¥çš„ full_response æˆ– chunkï¼‰
            let displayHTML = '';
            
            // å¦‚æœæœ‰æ€è€ƒå†…å®¹ï¼Œæ˜¾ç¤ºåœ¨å‰é¢
            if (thought && thought.trim()) {
                displayHTML += `
                    <div class="thought-section bg-amber-50 border border-amber-200 rounded-lg p-2 mb-2 text-[10px]">
                        <div class="font-bold text-amber-700 mb-1 flex items-center gap-1">
                            <span>ğŸ’­</span> æ€è€ƒè¿‡ç¨‹
                        </div>
                        <div class="text-amber-800 whitespace-pre-wrap">${escapeHtml(thought)}</div>
                    </div>`;
            }
            
            // æ˜¾ç¤ºä¸»å†…å®¹
            if (content && content.trim()) {
                try {
                    const parsedContent = marked.parse(content);
                    displayHTML += `<div class="md-prose">${parsedContent}</div>`;
                    console.log('Parsed markdown successfully, parsed length:', parsedContent.length);
                } catch (e) {
                    console.error('Markdown parse error:', e);
                    displayHTML += `<div class="md-prose">${escapeHtml(content)}</div>`;
                }
            } else if (!isThoughtMessage && !thought) {
                displayHTML += '<div class="md-prose"><span class="text-slate-400 animate-pulse">æ­£åœ¨æ€è€ƒ...</span></div>';
            }
            
            console.log('displayHTML length:', displayHTML.length);
            
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ streaming-message å…ƒç´ 
            if (streamingMsg && isStreaming) {
                // æ›´æ–°ç°æœ‰æ¶ˆæ¯
                const contentDiv = streamingMsg.querySelector('.message-content');
                console.log('Found contentDiv:', !!contentDiv);
                if (contentDiv) {
                    contentDiv.innerHTML = displayHTML;
                    console.log('Updated existing message HTML');
                }
            } else {
                // åˆ›å»ºæ–°çš„æµå¼æ¶ˆæ¯
                isStreaming = true;
                const div = document.createElement('div');
                div.className = 'flex justify-start w-full';
                div.innerHTML = `
                    <div class="flex flex-col max-w-[90%] streaming-message">
                        <span class="text-[10px] font-bold text-slate-400 ml-1 mb-1">AI Agent</span>
                        <div class="bg-white border-slate-200 text-slate-700 border p-3 rounded-2xl rounded-tl-sm shadow-sm text-xs leading-relaxed">
                            <div class="message-content">${displayHTML}</div>
                        </div>
                    </div>`;
                chatMessages.appendChild(div);
                console.log('Created and appended new message');
            }
            
            console.log('chatMessages children count:', chatMessages.children.length);
            console.log('=== updateOrCreateAIMessage END ===');
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ç»“æŸå½“å‰æµå¼æ¶ˆæ¯ï¼Œå…è®¸ä¸‹ä¸€ä¸ªæ¶ˆæ¯åˆ›å»ºæ–°æ°”æ³¡
        function finishCurrentStreamMessage() {
            const streamingMsg = chatMessages.querySelector('.streaming-message');
            if (streamingMsg) {
                streamingMsg.classList.remove('streaming-message');
            }
            isStreaming = false;
            accumulatedThought = '';
        }

        function updateLastAIMessage(content) {
            // å…¼å®¹æ—§è°ƒç”¨ï¼Œé‡å®šå‘åˆ°æ–°å‡½æ•°
            updateOrCreateAIMessage(content);
        }

        // ==========================================
        // æ­¥éª¤æ¨è¿›
        // ==========================================
        function advanceStep() {
            const currentIdx = testSteps.findIndex(s => s.status === "1");
            if (currentIdx >= 0) {
                testSteps[currentIdx].status = "3"; // Pass
                if (currentIdx < testSteps.length - 1) {
                    testSteps[currentIdx + 1].status = "1"; // Running
                    addLog('info', `Advancing to Step ${currentIdx + 2}`);
                }
                renderTestSteps();
            }
        }

        // ==========================================
        // æŠ¥å‘Šç”Ÿæˆ
        // ==========================================
        function submitReport() {
            const completed = testSteps.filter(s => s.status === "3").length;
            const rate = Math.round((completed / testSteps.length) * 100);
            
            const report = {
                project: 'cTDP Consistency Test',
                timestamp: new Date().toISOString(),
                device: 'Hygon 7002',
                completionRate: rate,
                status: rate === 100 ? 'PASSED' : (rate > 0 ? 'IN_PROGRESS' : 'FAILED'),
                steps: testSteps
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test_report_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('success', `Report generated: ${rate}% complete`);
        }

        // ==========================================
        // åˆå§‹åŒ–
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // æ¸²æŸ“æµ‹è¯•æ­¥éª¤
            renderTestSteps();

            // è®¾ç½®é»˜è®¤ Tab
            switchTab('bios');

            // è¿æ¥ WebSocket
            setTimeout(connectWebSocket, 500);

            // å¿«æ·é”®ç›‘å¬
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
