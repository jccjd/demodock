<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIBE Studio - iFlow CLI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .mono { font-family: 'JetBrains Mono', 'Fira Code', monospace; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
        .terminal-scroll::-webkit-scrollbar { width: 6px; }
        .terminal-scroll::-webkit-scrollbar-track { background: transparent; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Markdown ä¸“å±æ’ç‰ˆæ ·å¼ */
        .md-prose { font-size: 12px; line-height: 1.6; color: #334155; word-wrap: break-word; }
        .md-prose p { margin-bottom: 0.5rem; }
        .md-prose p:last-child { margin-bottom: 0; }
        .md-prose strong { font-weight: 600; color: #0f172a; }
        .md-prose ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 0.5rem; }
        .md-prose ol { list-style-type: decimal; padding-left: 1.25rem; margin-bottom: 0.5rem; }
        .md-prose li { margin-bottom: 0.25rem; }
        .md-prose code { font-family: 'JetBrains Mono', monospace; background-color: rgba(0,0,0,0.06); padding: 0.1rem 0.25rem; border-radius: 0.25rem; color: #db2777; font-size: 11px; }
        .md-prose pre { background-color: #f1f5f9; padding: 0.75rem; border-radius: 0.375rem; overflow-x: auto; margin-bottom: 0.5rem; border: 1px solid #e2e8f0; }
        .md-prose pre code { background-color: transparent; padding: 0; color: #334155; }
        
        /* AI èŠå¤©åŒº Markdown æ ·å¼ (æ·±è‰²ä¸»é¢˜) */
        .md-dark { font-size: 12px; line-height: 1.6; color: #d4d4d4; word-wrap: break-word; }
        .md-dark p { margin-bottom: 0.4rem; }
        .md-dark p:last-child { margin-bottom: 0; }
        .md-dark strong { font-weight: 600; color: #58a6ff; }
        .md-dark ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 0.4rem; }
        .md-dark ol { list-style-type: decimal; padding-left: 1.25rem; margin-bottom: 0.4rem; }
        .md-dark li { margin-bottom: 0.2rem; }
        .md-dark code { font-family: 'JetBrains Mono', monospace; background-color: #264f78; padding: 0.1rem 0.25rem; border-radius: 0.25rem; color: #ce9178; font-size: 11px; }
        .md-dark pre { background-color: #1e1e1e; padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto; margin-bottom: 0.4rem; border: 1px solid #3c3c3c; }
        .md-dark pre code { background-color: transparent; padding: 0; color: #d4d4d4; }

        /* æ­¥éª¤å¡ç‰‡æ‰‹é£ç´åŠ¨ç”» */
        .step-details {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out; opacity: 0;
        }
        .step-details.expanded { max-height: 1200px; opacity: 1; overflow-y: auto; }
        .rotate-icon { transition: transform 0.2s; }
        .expanded .rotate-icon { transform: rotate(180deg); }
        
        /* å…‰æ ‡é—ªçƒ */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .cursor-blink { animation: blink 1s infinite; }
        
        /* åº•éƒ¨é¢æ¿ Tab æ ·å¼ */
        .bottom-tab { 
            padding: 4px 12px; 
            font-size: 11px; 
            font-weight: 500;
            color: #6e7681;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .bottom-tab:hover { color: #e6edf3; }
        .bottom-tab.active { 
            color: #e6edf3; 
            border-bottom-color: #58a6ff;
        }
        
        /* éšè—é¢æ¿ */
        .panel-hidden { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-[13px] bg-slate-50 antialiased">

    <!-- 1. é¡¶éƒ¨çŠ¶æ€æ  -->
    <header class="h-12 border-b border-slate-200 bg-white flex items-center justify-between px-4 shrink-0 z-20 shadow-sm">
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
                <div class="w-7 h-7 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-md flex items-center justify-center text-white font-bold text-sm shadow-inner">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <span class="font-bold text-slate-800 tracking-tight">VIBE STUDIO</span>
            </div>
            <div class="flex items-center space-x-2 text-xs">
                <span class="text-slate-400">Task:</span>
                <span id="header-task-title" class="px-2 py-0.5 bg-slate-100 text-slate-700 rounded font-medium border border-slate-200 truncate max-w-md">iFlow CLI Console</span>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="flex items-center space-x-2 px-3 py-1 bg-slate-100 rounded border border-slate-200 shadow-inner">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></span>
                <span id="status-text" class="text-[11px] text-slate-600 font-bold mono">Offline</span>
            </div>
            <!-- è®¾å¤‡ IP -->
            <div class="flex items-center space-x-2 px-3 py-1 bg-slate-100 rounded border border-slate-200 shadow-inner">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span id="header-device-ip" class="text-[11px] text-slate-600 font-bold mono">localhost:8082</span>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- 2. å·¦ä¾§æµ‹è¯•æ­¥éª¤ Explorer -->
        <aside class="w-[320px] border-r border-slate-200 bg-white flex flex-col shrink-0 z-10 shadow-[2px_0_8px_rgba(0,0,0,0.02)]">
            <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                <span class="text-[11px] font-bold text-slate-700 uppercase tracking-widest flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    Execution Steps
                </span>
                <span id="step-count-badge" class="bg-slate-200 text-slate-600 text-[10px] px-1.5 py-0.5 rounded font-bold">0</span>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2.5 bg-slate-50/50" id="test-steps-container">
                <!-- é»˜è®¤æç¤º -->
                <div class="text-center py-8 text-slate-400 text-xs">
                    <svg class="w-8 h-8 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    æš‚æ— æµ‹è¯•æ­¥éª¤<br>å‘é€æŒ‡ä»¤åå°†æ˜¾ç¤ºæ‰§è¡Œæ­¥éª¤
                </div>
            </div>
        </aside>

        <!-- 3. ä¸­éƒ¨å·¥ä½œåŒº (VNC + åº•éƒ¨ AI Panel) -->
        <main class="flex-1 flex flex-col min-w-[300px] bg-slate-200/80">
            <!-- VNC Tab -->
            <div class="h-10 flex items-end px-2 pt-2 space-x-1 shrink-0">
                <button id="tab-console" onclick="UI.switchTab('console')" class="px-4 py-2 bg-white border border-b-0 border-slate-200 text-[11px] font-bold text-blue-600 rounded-t-lg shadow-sm">OS Console</button>
                <button id="tab-bmc" onclick="UI.switchTab('bmc')" class="px-4 py-2 bg-slate-100 text-[11px] font-medium text-slate-500 hover:bg-white rounded-t-lg transition-colors">BMC Web</button>
            </div>
            
            <!-- VNC åŒºåŸŸ -->
            <div class="flex-1 p-4 flex flex-col min-h-[200px]">
                <div class="flex-1 bg-[#0f111a] rounded-xl overflow-hidden border border-slate-800 shadow-2xl relative flex items-center justify-center">
                    <iframe id="vnc-frame" src="about:blank" class="w-full h-full border-0 absolute inset-0 z-10 hidden"></iframe>
                    <div id="vnc-placeholder" class="absolute inset-0 flex flex-col items-center justify-center z-0">
                        <div class="w-14 h-14 mb-3 rounded-xl bg-slate-800 flex items-center justify-center">
                            <svg class="w-7 h-7 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <span class="text-slate-500 text-sm" id="vnc-msg">Waiting for VNC connection...</span>
                    </div>
                </div>
            </div>
            
            <!-- åº•éƒ¨ AI Agent Protocol é¢æ¿ (å‚è€ƒå›¾ç‰‡æ ·å¼) -->
            <div class="h-[420px] bg-[#1e1e2e] flex flex-col shrink-0 border-t border-[#3c3c4f] shadow-[0_-5px_15px_rgba(0,0,0,0.2)]">
                <!-- Tab æ  -->
                <div class="flex items-center justify-between px-2 bg-[#181825] h-9 shrink-0 border-b border-[#3c3c4f]">
                    <div class="flex items-center">
                        <button id="bottom-tab-ai" onclick="BottomPanel.switchTab('ai')" class="bottom-tab active">
                            <span class="flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                AI Agent Protocol
                            </span>
                        </button>
                        <button id="bottom-tab-logs" onclick="BottomPanel.switchTab('logs')" class="bottom-tab">
                            <span class="flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                System Logs
                            </span>
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- è¿æ¥çŠ¶æ€ -->
                        <div class="flex items-center space-x-1.5 px-2 py-0.5 bg-black/30 rounded text-[10px]">
                            <span id="ws-dot" class="w-2 h-2 bg-red-500 rounded-full"></span>
                            <span id="ws-text" class="text-slate-400">Offline</span>
                        </div>
                        <button onclick="BottomPanel.clearCurrent()" class="text-slate-500 hover:text-white text-[10px] uppercase tracking-wider font-bold transition-colors px-2">Clear</button>
                    </div>
                </div>
                
                <!-- AI Chat é¢æ¿ -->
                <div id="panel-ai" class="flex-1 flex flex-col min-h-0">
                    <!-- èŠå¤©è®°å½• -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 terminal-scroll mono text-[12px] leading-relaxed space-y-3">
                        <div class="text-center text-[11px] text-slate-500 my-2">Waiting for server connection...</div>
                    </div>
                    <!-- è¾“å…¥åŒº -->
                    <div class="border-t border-[#3c3c4f] p-3 bg-[#181825] shrink-0">
                        <div class="flex items-center gap-3 bg-[#1e1e1e] rounded-lg px-4 py-3 border border-[#3c3c4f] focus-within:border-blue-500 transition-colors">
                            <span class="text-blue-400 text-base">â€º</span>
                            <input 
                                id="chat-input" 
                                type="text" 
                                placeholder="Type your message or instruction... (Enter to send)" 
                                class="flex-1 bg-transparent text-[14px] text-slate-200 placeholder-slate-500 outline-none mono disabled:opacity-50"
                                disabled
                            >
                            <button id="send-btn" onclick="ChatClient.sendMessage()" class="px-4 py-2 bg-blue-600 text-white rounded-md text-[12px] font-medium hover:bg-blue-700 disabled:bg-slate-700 disabled:text-slate-500 transition-colors" disabled>
                                Send
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- System Logs é¢æ¿ -->
                <div id="panel-logs" class="flex-1 overflow-y-auto p-3 terminal-scroll mono text-[12px] leading-relaxed panel-hidden"></div>
            </div>
        </main>

        <!-- 4. å³ä¾§é¢æ¿ - ç§»é™¤ï¼Œå·²æ•´åˆåˆ°åº•éƒ¨ -->
    </div>

    <!-- ========================================== -->
    <!-- ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘å¼•æ“ -->
    <!-- ========================================== -->
    <script>
        // é…ç½®ä¸­å¿ƒ
        const HOST = window.location.hostname || 'localhost';
        const AppConfig = {
            WS_URL: `ws://${HOST}:8082/ws`,
            HEALTH_URL: `http://${HOST}:8082/health`,
            VNC_CONSOLE_URL: `novnc/vnc_lite.html?host=${HOST}&port=6080&path=websockify`,
            VNC_BMC_URL: `http://10.8.135.251:3000/vnc/index.html?autoconnect=true`
        };

        // åˆå§‹åŒ– marked é€‰é¡¹
        marked.setOptions({ gfm: true, breaks: true });

        // çŠ¶æ€å˜é‡
        let currentAIMessage = null;
        let toolCallMessages = {};
        let executionSteps = [];
        let vncConnected = false;

        // 1. UI æ¨¡å—
        const UI = {
            switchTab(tabId) {
                const tabs = { 
                    console: document.getElementById('tab-console'), 
                    bmc: document.getElementById('tab-bmc') 
                };
                const frame = document.getElementById('vnc-frame');
                const activeCls = "px-4 py-2 bg-white border border-b-0 border-slate-200 text-[11px] font-bold text-blue-600 rounded-t-lg shadow-sm";
                const inactiveCls = "px-4 py-2 bg-slate-100 text-[11px] font-medium text-slate-500 hover:bg-white rounded-t-lg transition-colors";

                if (tabId === 'console') {
                    tabs.console.className = activeCls; 
                    tabs.bmc.className = inactiveCls;
                    frame.src = AppConfig.VNC_CONSOLE_URL;
                } else {
                    tabs.bmc.className = activeCls; 
                    tabs.console.className = inactiveCls;
                    frame.src = AppConfig.VNC_BMC_URL;
                }
                
                if (vncConnected) {
                    frame.classList.remove('hidden');
                    document.getElementById('vnc-placeholder').classList.add('hidden');
                }
            }
        };

        // 2. åº•éƒ¨é¢æ¿æ¨¡å—
        const BottomPanel = {
            currentTab: 'ai',
            switchTab(tabId) {
                this.currentTab = tabId;
                const tabAI = document.getElementById('bottom-tab-ai');
                const tabLogs = document.getElementById('bottom-tab-logs');
                const panelAI = document.getElementById('panel-ai');
                const panelLogs = document.getElementById('panel-logs');
                
                if (tabId === 'ai') {
                    tabAI.classList.add('active');
                    tabLogs.classList.remove('active');
                    panelAI.classList.remove('panel-hidden');
                    panelLogs.classList.add('panel-hidden');
                } else {
                    tabLogs.classList.add('active');
                    tabAI.classList.remove('active');
                    panelLogs.classList.remove('panel-hidden');
                    panelAI.classList.add('panel-hidden');
                }
            },
            clearCurrent() {
                if (this.currentTab === 'ai') {
                    ChatClient.clearChat();
                } else {
                    Logger.clear();
                }
            }
        };

        // 3. Logger æ¨¡å—
        const Logger = {
            container: document.getElementById('panel-logs'),
            log(type, message) {
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                const div = document.createElement('div');
                div.className = 'flex space-x-3 mb-1 hover:bg-white/5 px-1 rounded';
                let color = type === 'error' ? 'text-[#ef5350]' : (type === 'success' ? 'text-[#6ac96a]' : (type === 'cmd' ? 'text-[#82aaff]' : 'text-[#a6accd]'));
                let prefix = type === 'error' ? '[ERROR]' : (type === 'success' ? '[SUCCESS]' : (type === 'cmd' ? '[EXEC]' : '[INFO]'));
                div.innerHTML = `<span class="text-[#6e7681] shrink-0">[${time}]</span> <span class="${color} shrink-0">${prefix}</span> <span class="text-[#d4d4d4] whitespace-pre-wrap break-words">${this.escape(message)}</span>`;
                this.container.appendChild(div);
                this.container.scrollTop = this.container.scrollHeight;
            },
            clear() { this.container.innerHTML = ''; },
            escape(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
        };

        // 4. æµ‹è¯•æ­¥éª¤æ¨¡å—
        const TestManager = {
            steps: [],
            stripMarkdown(mdText) {
                if (!mdText) return 'No description';
                let plainText = mdText
                    .replace(/(\*\*|__)(.*?)\1/g, '$2').replace(/(\*|_)(.*?)\1/g, '$2')
                    .replace(/```[\s\S]*?```/g, ' [Code Block] ').replace(/`([^`]+)`/g, '$1')
                    .replace(/^(\d+\\\.|-|\*|\+)\s+/gm, '').replace(/\\/g, '').replace(/\n/g, ' ').trim();
                return plainText.length > 55 ? plainText.substring(0, 55) + '...' : plainText;
            },
            addStep(step) {
                this.steps.push(step);
                document.getElementById('step-count-badge').textContent = this.steps.length;
                this.render();
            },
            updateStep(stepId, status, actualResult) {
                const step = this.steps.find(s => s.step_id === stepId);
                if (step) {
                    step.status = status;
                    if (actualResult) step.actual_result = actualResult;
                    this.render();
                }
            },
            toggleStep(element) {
                const detailsDiv = element.nextElementSibling;
                const wrapperDiv = element.parentElement;
                if (detailsDiv.classList.contains('expanded')) {
                    detailsDiv.classList.remove('expanded'); wrapperDiv.classList.remove('shadow-md');
                } else {
                    document.querySelectorAll('.step-details.expanded').forEach(el => { el.classList.remove('expanded'); el.parentElement.classList.remove('shadow-md'); });
                    detailsDiv.classList.add('expanded'); wrapperDiv.classList.add('shadow-md');
                }
            },
            render() {
                const container = document.getElementById('test-steps-container');
                container.innerHTML = '';
                const statusMap = {
                    "0": { text: "Waiting", border: "border-slate-200", bg: "bg-white", badge: "bg-slate-100 text-slate-500", icon: "â³" },
                    "1": { text: "Pass", border: "border-emerald-300", bg: "bg-emerald-50/30", badge: "bg-emerald-100 text-emerald-700", icon: "âœ…" },
                    "2": { text: "Failed", border: "border-red-300", bg: "bg-red-50/50", badge: "bg-red-100 text-red-700", icon: "âŒ" },
                    "3": { text: "Running", border: "border-blue-400", bg: "bg-blue-50/50", badge: "bg-blue-100 text-blue-700", icon: "ğŸ”„" }
                };

                if (this.steps.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-slate-400 text-xs">
                            <svg class="w-8 h-8 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            æš‚æ— æµ‹è¯•æ­¥éª¤<br>å‘é€æŒ‡ä»¤åå°†æ˜¾ç¤ºæ‰§è¡Œæ­¥éª¤
                        </div>`;
                    return;
                }

                this.steps.forEach((step, index) => {
                    const statusObj = statusMap[step.status] || statusMap["0"];
                    const summary = this.stripMarkdown(step.description);
                    const htmlDesc = marked.parse(step.description || 'æ— æè¿°');
                    const htmlExpected = marked.parse(step.expected_result || 'æ— é¢„æœŸç»“æœ');
                    const htmlActual = step.actual_result ? marked.parse(step.actual_result) : null;
                    const isExpanded = index === this.steps.length - 1 ? 'expanded' : '';
                    const hasShadow = index === this.steps.length - 1 ? 'shadow-md' : '';

                    container.innerHTML += `
                        <div class="mb-3 rounded-lg border ${statusObj.border} ${statusObj.bg} transition-shadow duration-300 ${hasShadow} bg-white">
                            <div class="px-3 py-2.5 cursor-pointer flex flex-col gap-1.5 select-none" onclick="TestManager.toggleStep(this)">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-[12px] text-slate-800 flex items-center gap-1.5"><span>${statusObj.icon}</span> Step ${step.step_number}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${statusObj.badge}">${statusObj.text}</span>
                                        <svg class="w-4 h-4 text-slate-400 rotate-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                                <div class="text-[11px] text-slate-500 truncate pr-6">${summary}</div>
                            </div>
                            <div class="step-details ${isExpanded} border-t border-slate-100/80 bg-slate-50/30 rounded-b-lg custom-scrollbar">
                                <div class="p-4 flex flex-col gap-4">
                                    <div>
                                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5">Description</div>
                                        <div class="md-prose">${htmlDesc}</div>
                                    </div>
                                    <div class="pt-3 border-t border-slate-200 border-dashed">
                                        <div class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1.5">Expected</div>
                                        <div class="md-prose">${htmlExpected}</div>
                                    </div>
                                    ${htmlActual ? `
                                    <div class="pt-3 border-t border-slate-200 border-dashed">
                                        <div class="text-[10px] font-bold ${step.status === '2' ? 'text-red-500' : 'text-emerald-500'} uppercase tracking-wider mb-1.5">Actual Result</div>
                                        <div class="md-prose ${step.status === '2' ? 'text-red-700 bg-red-50/50 p-2 rounded border border-red-100' : ''}">${htmlActual}</div>
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>`;
                });
            }
        };

        // 5. AI é€šä¿¡æ¨¡å—
        const ChatClient = {
            ws: null,
            isConnected: false,
            elements: {
                container: document.getElementById('chat-messages'),
                input: document.getElementById('chat-input'),
                btn: document.getElementById('send-btn'),
                dot: document.getElementById('ws-dot'),
                text: document.getElementById('ws-text')
            },

            init() {
                this.elements.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); this.sendMessage(); }
                });
                this.connect();
            },

            async connect() {
                try {
                    const response = await fetch(AppConfig.HEALTH_URL, { method: 'GET' });
                    if (!response.ok) {
                        this.updateStatus('offline');
                        setTimeout(() => this.connect(), 5000);
                        return;
                    }
                } catch (e) {
                    this.updateStatus('offline');
                    this.showOfflineMessage();
                    setTimeout(() => this.connect(), 5000);
                    return;
                }

                this.updateStatus('connecting');
                Logger.log('info', `Connecting to ${AppConfig.WS_URL}...`);

                try {
                    this.ws = new WebSocket(AppConfig.WS_URL);
                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.updateStatus('connected');
                        this.elements.container.innerHTML = '';
                        this.addMessage('system', 'âœ“ Agent protocol active. Ready for instructions.');
                        Logger.log('success', 'WebSocket connected.');
                    };
                    this.ws.onmessage = (e) => this.handleMessage(e.data);
                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateStatus('offline');
                        Logger.log('error', 'WebSocket disconnected, reconnecting...');
                        setTimeout(() => this.connect(), 5000);
                    };
                    this.ws.onerror = () => { Logger.log('error', 'WebSocket error'); };
                } catch (err) {
                    this.updateStatus('offline');
                    Logger.log('error', 'Connection failed: ' + err.message);
                    setTimeout(() => this.connect(), 5000);
                }
            },

            showOfflineMessage() {
                if (this.elements.container.children.length <= 1) {
                    this.elements.container.innerHTML = `
                        <div class="text-center py-4 text-slate-500 text-[11px]">
                            <span class="text-red-400">â—</span> æœåŠ¡å™¨ç¦»çº¿ - è¯·å¯åŠ¨åç«¯æœåŠ¡
                            <code class="ml-2 bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">uv run python src/server.py</code>
                        </div>
                    `;
                }
            },

            updateStatus(state) {
                const el = this.elements;
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                
                if (state === 'connected') {
                    el.dot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                    el.text.textContent = 'Online';
                    el.text.className = 'text-green-400';
                    el.input.disabled = el.btn.disabled = false;
                    statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    statusText.textContent = 'Online';
                } else if (state === 'connecting') {
                    el.dot.className = 'w-2 h-2 bg-yellow-500 rounded-full';
                    el.text.textContent = 'Connecting...';
                    el.text.className = 'text-yellow-400';
                    statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500';
                    statusText.textContent = 'Connecting';
                } else {
                    el.dot.className = 'w-2 h-2 bg-red-500 rounded-full';
                    el.text.textContent = 'Offline';
                    el.text.className = 'text-red-400';
                    el.input.disabled = el.btn.disabled = true;
                    statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                    statusText.textContent = 'Offline';
                }
            },

            handleMessage(rawData) {
                try {
                    const data = JSON.parse(rawData);
                    if (data.type === 'tool_use' || data.type === 'tool_call') {
                        this.finishCurrentMessage();
                        this.handleToolCall(data);
                    } else if (data.type === 'task_finish') {
                        this.finishCurrentMessage();
                        toolCallMessages = {};
                        Logger.log('success', 'Task finished: ' + (data.stop_reason || 'completed'));
                    } else if (data.type === 'step') {
                        TestManager.addStep(data.step);
                        Logger.log('info', `Step ${data.step.step_number}: ${data.step.description?.substring(0, 50)}...`);
                    } else if (data.type === 'assistant' || data.type === 'stream' || data.status === 'streaming') {
                        const chunk = data.chunk || '';
                        if (chunk) this.updateOrCreateAIMessage(chunk);
                    } else if (data.type === 'error') {
                        this.addMessage('system', 'âœ— Error: ' + (data.error || data.message || 'Unknown error'));
                        Logger.log('error', data.error || data.message);
                    } else if (data.chunk || data.full_response) {
                        this.updateOrCreateAIMessage(data.chunk || '');
                    } else if (data.content || data.message) {
                        this.addMessage('ai', data.content || data.message);
                    }
                } catch (e) {
                    this.updateOrCreateAIMessage(rawData);
                }
            },

            handleToolCall(data) {
                const toolName = data.tool || data.tool_name || 'unknown';
                const toolArgs = data.args || data.arguments || {};
                const toolStatus = data.status || 'pending';
                const toolId = data.id || `${toolName}-${Date.now()}`;
                
                const statusIcons = {
                    pending: 'â³',
                    in_progress: 'ğŸ”„',
                    completed: 'âœ“',
                    error: 'âœ—'
                };
                
                const s = statusIcons[toolStatus] || statusIcons.pending;
                const argsStr = Object.keys(toolArgs).length > 0 ? JSON.stringify(toolArgs, null, 2) : '{}';
                
                const existingMsg = toolCallMessages[toolId];
                if (existingMsg) {
                    existingMsg.querySelector('.status-icon').textContent = s;
                } else {
                    this.addMessage('tool', `${s} **${toolName}**\n\`\`\`json\n${argsStr}\n\`\`\``);
                    Logger.log('cmd', `Tool: ${toolName} - ${toolStatus}`);
                }
            },

            sendMessage() {
                const text = this.elements.input.value.trim();
                if (!text || !this.isConnected) return;
                
                this.addMessage('user', text);
                this.elements.input.value = '';
                Logger.log('info', `User: ${text}`);
                
                try { this.ws.send(text); } 
                catch (e) { this.addMessage('system', 'âœ— Failed to send command.'); }
            },

            finishCurrentMessage() {
                if (currentAIMessage) {
                    const cursor = currentAIMessage.querySelector('.cursor-blink');
                    if (cursor) cursor.remove();
                    currentAIMessage = null;
                }
            },

            addMessage(role, content) {
                const div = document.createElement('div');
                div.className = 'mb-1.5';
                
                if (role === 'user') {
                    div.innerHTML = `<span class="text-blue-400">â€º</span> <span class="text-slate-200">${Logger.escape(content)}</span>`;
                } else if (role === 'system') {
                    div.innerHTML = `<span class="text-slate-500 text-[11px]">${Logger.escape(content)}</span>`;
                } else if (role === 'tool') {
                    const parsedHtml = marked.parse(content);
                    div.innerHTML = `<div class="md-dark bg-[#1e1e1e] p-2 rounded border border-[#3c3c3c]">${parsedHtml}</div>`;
                } else {
                    const parsedHtml = marked.parse(content);
                    div.innerHTML = `<span class="text-green-400">â—†</span> <span class="md-dark">${parsedHtml}</span>`;
                    // å¦‚æœåŒ…å« HTMLï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                    if (parsedHtml.includes('<')) {
                        div.innerHTML = `<span class="text-green-400">â—†</span> <div class="md-dark ml-4">${parsedHtml}</div>`;
                    }
                }

                this.elements.container.appendChild(div);
                this.elements.container.scrollTop = this.elements.container.scrollHeight;
            },

            updateOrCreateAIMessage(chunk) {
                if (!chunk || !chunk.trim()) return;
                
                if (!currentAIMessage) {
                    const div = document.createElement('div');
                    div.className = 'mb-1.5';
                    div.innerHTML = `<span class="text-green-400">â—†</span> <span class="text-slate-200"><span class="cursor-blink">â–Š</span></span>`;
                    this.elements.container.appendChild(div);
                    currentAIMessage = div;
                }
                
                const textSpan = currentAIMessage.querySelector('span:last-child');
                const cursor = textSpan.querySelector('.cursor-blink');
                if (cursor) cursor.remove();
                
                textSpan.innerHTML += Logger.escape(chunk);
                textSpan.innerHTML += '<span class="cursor-blink">â–Š</span>';
                
                this.elements.container.scrollTop = this.elements.container.scrollHeight;
            },

            clearChat() {
                this.elements.container.innerHTML = '<div class="text-center text-[11px] text-slate-500 my-2">New conversation started.</div>';
                toolCallMessages = {};
                currentAIMessage = null;
            }
        };

        // å¿«æ·å‘½ä»¤
        function quickCmd(cmd) {
            document.getElementById('chat-input').value = cmd;
            ChatClient.sendMessage();
        }

        // VNC è¿æ¥
        function connectVNC() {
            const frame = document.getElementById('vnc-frame');
            const placeholder = document.getElementById('vnc-placeholder');
            const vncMsg = document.getElementById('vnc-msg');
            
            vncMsg.textContent = 'Connecting...';
            
            frame.onload = () => {
                vncConnected = true;
                frame.classList.remove('hidden');
                placeholder.classList.add('hidden');
                Logger.log('success', 'VNC connected.');
            };
            
            frame.onerror = () => {
                vncMsg.textContent = 'Connection failed';
                Logger.log('error', 'VNC connection failed.');
            };
        }

        // å¯åŠ¨å¼•å¯¼
        document.addEventListener('DOMContentLoaded', () => {
            UI.switchTab('console');
            setTimeout(() => ChatClient.init(), 500);
            setTimeout(connectVNC, 1000);
        });

    </script>
</body>
</html>