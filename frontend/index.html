<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>VIBE Studio - Integrated Test Environment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #333; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .sidebar-icon-active { border-left: 2px solid #2563eb; color: #2563eb !important; background: #f0f7ff; }
        .vnc-area { background: #f3f4f6; position: relative; }
        .custom-scrollbar::-webkit-scrollbar { width: 3px; height: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        .ide-panel-header { background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-[13px]">

    <!-- é¡¶éƒ¨èœå•/å·¥å…·æ  (å…¨å±€çŠ¶æ€) -->
    <header class="h-10 border-b border-slate-200 flex items-center justify-between px-4 bg-white z-50">
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
                <div class="w-6 h-6 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-[10px]">V</div>
                <span class="font-bold text-slate-700 tracking-tight">VIBE STUDIO</span>
            </div>
            <div class="flex items-center space-x-1 text-slate-400">
                <span>Projects</span>
                <span class="text-slate-300">/</span>
                <span class="text-slate-900 font-medium italic">cTDP_Consistency_Test</span>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 px-3 py-1 bg-green-50 rounded-full border border-green-100">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                <span class="text-[10px] text-green-700 font-bold uppercase tracking-wider">Hygon 7002 Connected</span>
            </div>
            <button class="bg-blue-600 text-white px-4 py-1 rounded text-[11px] font-bold shadow-sm hover:bg-blue-700" onclick="submitReport()">Submit Report</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- 1. å·¦ä¾§æœ€çª„ä¾§è¾¹æ  (Activity Bar) -->
        <nav class="w-12 border-r border-slate-200 flex flex-col items-center py-4 space-y-6 bg-white">
            <div class="sidebar-icon-active p-2 text-slate-400 hover:text-blue-600 transition-colors cursor-pointer">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" stroke-width="2"></path></svg>
            </div>
            <div class="p-2 text-slate-400 hover:text-blue-600 transition-colors cursor-pointer">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2"></path></svg>
            </div>
            <div class="p-2 text-slate-400 hover:text-blue-600 transition-colors cursor-pointer">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"></path></svg>
            </div>
        </nav>

        <!-- 2. å·¦ä¾§ä¸»ä¾§è¾¹æ  (Explorer - Step Info) -->
        <aside class="w-64 border-r border-slate-200 flex flex-col bg-white">
            <div class="ide-panel-header px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest">
                Test Case Explorer
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar py-2">
                <!-- æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯ç»„ -->
                <div class="px-4 py-2 group">
                    <div class="flex items-center text-[11px] font-bold text-slate-400 mb-2 uppercase tracking-tighter">
                        <svg class="w-3 h-3 mr-1 transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"></path></svg>
                        Steps Details
                    </div>
                    <div class="space-y-1 ml-4 border-l border-slate-100">
                        <div class="pl-4 py-1 text-blue-600 font-bold bg-blue-50 border-r-2 border-blue-600 cursor-pointer">01. BIOS Config <span class="text-[9px] opacity-50 ml-2">Active</span></div>
                        <div class="pl-4 py-1 text-slate-500 hover:bg-slate-50 cursor-pointer">02. BMC Event Log <span class="text-[9px] opacity-50 ml-2 italic">Waiting</span></div>
                        <div class="pl-4 py-1 text-slate-500 hover:bg-slate-50 cursor-pointer">03. OS Power Stress <span class="text-[9px] opacity-50 ml-2 italic">Waiting</span></div>
                        <div class="pl-4 py-1 text-slate-500 hover:bg-slate-50 cursor-pointer">04. Topology Verify <span class="text-[9px] opacity-50 ml-2 italic">Final</span></div>
                    </div>
                </div>

                <div class="px-4 py-6">
                    <div class="flex items-center text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest italic">Target Specification</div>
                    <div class="p-3 bg-slate-50 rounded-lg text-[11px] text-slate-500 leading-relaxed border border-slate-100">
                        Hygon CBS -> NBIO -> cTDP Control -> Manual (Target: 280W)
                    </div>
                </div>
            </div>
        </aside>

        <!-- 3. ä¸­é—´æ ¸å¿ƒè§†å›¾åŒº (Main View - VNC + Panel) -->
        <main class="flex-1 flex flex-col min-w-0 bg-[#f9fafb]">
            <!-- æ ‡ç­¾é¡µ -->
            <div class="h-9 bg-slate-100/50 flex items-end px-4 border-b border-slate-200">
                <div id="tab-bios" class="px-4 py-2 bg-white border border-b-0 border-slate-200 text-[11px] font-bold text-blue-600 flex items-center space-x-2 rounded-t-md cursor-pointer" onclick="switchTab('bios')">
                    <span class="w-2 h-2 bg-indigo-500 rounded-full"></span>
                    <span>BIOS Console (Serial)</span>
                    <span class="text-slate-300 ml-2 hover:text-slate-600 cursor-pointer">Ã—</span>
                </div>
                <div id="tab-bmc" class="px-4 py-2 text-[11px] font-medium text-slate-400 hover:text-slate-600 flex items-center space-x-2 cursor-pointer transition-all" onclick="switchTab('bmc')">
                    <span class="w-2 h-2 bg-slate-300 rounded-full"></span>
                    <span>BMC Web (noVNC)</span>
                </div>
            </div>

            <!-- VNC ä¸»è§†çª— (å°±åƒä»£ç ç¼–è¾‘åŒº) -->
            <div class="flex-1 vnc-area overflow-hidden flex flex-col">
                <div class="flex-1 bg-black m-6 rounded-2xl shadow-2xl overflow-hidden border border-slate-800 flex flex-col relative">
                    <!-- HUD æç¤ºå±‚ -->
                    <div class="absolute top-4 left-1/2 -translate-x-1/2 px-4 py-1.5 bg-blue-600 text-white text-[10px] font-bold rounded-full shadow-lg flex items-center space-x-2 z-10">
                        <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                        <span>AI ATTACHED: Intercepting BIOS Boot...</span>
                    </div>
                    <!-- VNC å®¹å™¨ -->
                    <iframe 
                        id="vnc-frame"
                        src="http://localhost:8080/vnc/index.html?autoconnect=true"
                        class="w-full h-full border-0"
                        title="VNC Console"
                        allowfullscreen>
                    </iframe>
                </div>
            </div>

            <!-- åº•éƒ¨é¢æ¿ (Terminal/Output) -->
            <div class="h-48 border-t border-slate-200 bg-white flex flex-col shadow-inner">
                <div class="ide-panel-header px-4 flex items-center space-x-6 h-8 shrink-0">
                    <button class="text-[10px] font-bold text-slate-900 border-b-2 border-blue-600 pb-1">OUTPUT</button>
                    <button class="text-[10px] font-bold text-slate-400 hover:text-slate-600 pb-1">DEBUG CONSOLE</button>
                    <button class="text-[10px] font-bold text-slate-400 hover:text-slate-600 pb-1">REAL-TIME LOGS</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar mono text-[11px] text-slate-600 leading-loose">
                    <div class="flex space-x-4"><span class="text-blue-500">[14:21:05]</span><span class="text-slate-400">INFO: Powering on target system...</span></div>
                    <div class="flex space-x-4"><span class="text-blue-500">[14:21:08]</span><span class="text-slate-400">INFO: AI Agent detected serial output "Hygon Setup Ready".</span></div>
                    <div class="flex space-x-4"><span class="text-indigo-500 font-bold">[14:21:12]</span><span class="text-indigo-600">COMMAND: AI sending 'F2' interrupt key... success.</span></div>
                    <div class="flex space-x-4"><span class="text-emerald-500">[14:21:15]</span><span class="text-slate-500 italic">SYSTEM: Context switched to BIOS Console.</span></div>
                </div>
            </div>
        </main>

        <!-- 4. å³ä¾§ä¾§è¾¹æ  (AI Co-Tester - èåˆ ai_browser_chat) -->
        <aside class="w-96 border-l border-slate-200 flex flex-col bg-gradient-to-b from-slate-50 to-white">
            <!-- é¡¶éƒ¨è¿æ¥çŠ¶æ€ -->
            <div class="px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-between shadow-sm">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    </div>
                    <div>
                        <div class="text-white font-bold text-sm">AI Co-Tester</div>
                        <div class="text-blue-100 text-[10px]">iFlow SDK + MCP Browser</div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span id="ws-status-dot" class="w-2.5 h-2.5 bg-slate-400 rounded-full"></span>
                    <span id="ws-status-text" class="text-[10px] text-blue-100 font-medium">æœªè¿æ¥</span>
                </div>
            </div>

            <!-- ç¤ºä¾‹æŒ‡ä»¤ -->
            <div class="px-4 py-3 bg-white border-b border-slate-100">
                <div class="text-[10px] text-slate-400 font-medium mb-2">ğŸ’¡ å¿«æ·æŒ‡ä»¤:</div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="quickCommand('å¸®æˆ‘æ‰“å¼€ç™¾åº¦æœç´¢äººå·¥æ™ºèƒ½')" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-full text-[10px] font-medium hover:bg-blue-100 transition-colors">æœç´¢äººå·¥æ™ºèƒ½</button>
                    <button onclick="quickCommand('åˆ—å‡ºå½“å‰å·¥ä½œç›®å½•çš„æ–‡ä»¶')" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-full text-[10px] font-medium hover:bg-blue-100 transition-colors">åˆ—å‡ºæ–‡ä»¶</button>
                    <button onclick="quickCommand('å¸®æˆ‘åˆ†æ demo.html çš„ç»“æ„')" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-full text-[10px] font-medium hover:bg-blue-100 transition-colors">åˆ†æä»£ç </button>
                </div>
            </div>

            <!-- å¯¹è¯è®°å½• -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div class="flex justify-center">
                    <div class="text-[10px] text-slate-400 bg-slate-50 px-3 py-2 rounded-full flex items-center space-x-2">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>ç­‰å¾…è¿æ¥åˆ°æœåŠ¡å™¨...</span>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="p-4 bg-white border-t border-slate-200 shadow-lg">
                <div class="relative">
                    <textarea id="chat-input" rows="3" placeholder="è¾“å…¥æŒ‡ä»¤... (Ctrl+Enter å‘é€)" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 pr-12 text-xs outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all resize-none placeholder:text-slate-400 shadow-inner" disabled></textarea>
                    <button id="send-btn" class="absolute right-3 bottom-3 p-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg shadow-md hover:shadow-lg disabled:bg-slate-300 disabled:cursor-not-allowed transition-all" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </aside>

    </div>

    <!-- AI Chat WebSocket è¿æ¥è„šæœ¬ -->
    <script>
        // WebSocket é…ç½®
        const WS_URL = 'ws://localhost:8082/ws';
        const HEALTH_URL = 'http://localhost:8082/health';
        let ws = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;

        // DOM å…ƒç´ 
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const statusDot = document.getElementById('ws-status-dot');
        const statusText = document.getElementById('ws-status-text');

        // æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
        async function checkServerHealth() {
            try {
                const response = await fetch(HEALTH_URL, { method: 'GET' });
                if (response.ok) {
                    return { healthy: true, data: await response.json() };
                }
                return { healthy: false, status: response.status };
            } catch (e) {
                return { healthy: false, error: e.message };
            }
        }

        // æ˜¾ç¤ºæœåŠ¡ä¾èµ–è¯´æ˜
        function showServiceDependencyInfo() {
            clearMessages();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'space-y-2 text-xs';
            msgDiv.innerHTML = `
                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">ğŸ“‹ å¯åŠ¨æœåŠ¡ä¾èµ–</div>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 space-y-2">
                    <div class="flex items-start gap-2">
                        <span class="text-amber-500">âš ï¸</span>
                        <div class="text-slate-600">
                            <div class="font-medium mb-1">éœ€è¦å¯åŠ¨ä»¥ä¸‹æœåŠ¡ï¼š</div>
                            <div class="font-mono text-[10px] space-y-1 ml-2">
                                <div class="text-slate-500">1. iFlow ACP Server:</div>
                                <div class="text-blue-600 bg-blue-50 px-2 py-1 rounded">iflow --experimental-acp --port 8090</div>
                                <div class="text-slate-500 mt-2">2. Browser Server:</div>
                                <div class="text-blue-600 bg-blue-50 px-2 py-1 rounded">uv run python src/server.py</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(msgDiv);
            scrollToBottom();
        }

        // è¿æ¥åˆ° WebSocket æœåŠ¡å™¨
        async function connectWebSocket() {
            // å…ˆæ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
            const health = await checkServerHealth();
            
            if (!health.healthy) {
                showServiceDependencyInfo();
                updateConnectionStatus(false, 'æœåŠ¡å™¨ç¦»çº¿');
                enableInput(false);
                
                reconnectAttempts++;
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    const delay = Math.min(5000 * reconnectAttempts, 30000);
                    setTimeout(connectWebSocket, delay);
                }
                return;
            }

            console.log('å°è¯•è¿æ¥åˆ°:', WS_URL);
            reconnectAttempts = 0;

            try {
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log('WebSocket è¿æ¥æˆåŠŸ');
                    isConnected = true;
                    updateConnectionStatus(true, 'å·²è¿æ¥');
                    clearMessages();
                    addSystemMessage('âœ… å·²è¿æ¥åˆ° iFlow Browser Server');
                    addSystemMessage(`ğŸ“Œ ACP: ${health.data?.iflow_url || 'ws://localhost:8090/acp'}`);
                    enableInput(true);
                };

                ws.onmessage = (event) => {
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
                    const data = event.data;

                    try {
                        const parsed = JSON.parse(data);
                        handleMessage(parsed);
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥æ˜¾ç¤ºä¸ºæ–‡æœ¬
                        addAIMessage(data);
                    }
                };

                ws.onclose = (event) => {
                    console.log('WebSocket è¿æ¥å…³é—­:', event.code, event.reason);
                    isConnected = false;
                    updateConnectionStatus(false, 'è¿æ¥æ–­å¼€');
                    addSystemMessage('âš ï¸ ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                    enableInput(false);
                    // 5ç§’åé‡è¿
                    setTimeout(connectWebSocket, 5000);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket é”™è¯¯:', error);
                    updateConnectionStatus(false, 'è¿æ¥é”™è¯¯');
                    addSystemMessage('âŒ WebSocket è¿æ¥å¤±è´¥');
                };

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                updateConnectionStatus(false, 'è¿æ¥å¤±è´¥');
                addSystemMessage('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ' + error.message);
                // 5ç§’åé‡è¯•
                setTimeout(connectWebSocket, 5000);
            }
        }

        // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
        function handleMessage(data) {
            if (data.type === 'assistant' || data.type === 'stream' || data.type === 'message') {
                // ä¼˜å…ˆä½¿ç”¨ chunk æˆ– full_response
                if (data.chunk || data.full_response) {
                    updateLastAIMessage(data.full_response || data.chunk);
                    // åŒæ­¥åˆ°æ—¥å¿—é¢æ¿
                    if (data.chunk) {
                        addLog('info', `AI: ${data.chunk}`);
                    }
                } else {
                    addAIMessage(data.content || data.message || data.text || '');
                    addLog('info', `AI: ${data.content || data.message || data.text}`);
                }
            } else if (data.type === 'tool_use') {
                addToolMessage(data.tool, data.args);
                // åŒæ­¥åˆ°æ—¥å¿—é¢æ¿
                addLog('command', `å·¥å…·è°ƒç”¨: ${data.tool}`);
            } else if (data.type === 'plan') {
                addPlanMessage(data.entries);
                // åŒæ­¥åˆ°æ—¥å¿—é¢æ¿
                addLog('info', `ç”Ÿæˆæ‰§è¡Œè®¡åˆ’: ${data.entries.length} ä¸ªæ­¥éª¤`);
            } else if (data.type === 'task_finish') {
                // ä»»åŠ¡å®Œæˆ
                console.log('ä»»åŠ¡å®Œæˆ:', data.stop_reason);
                addLog('success', `ä»»åŠ¡å®Œæˆ: ${data.stop_reason}`);
                // è‡ªåŠ¨å®Œæˆå½“å‰æµ‹è¯•æ­¥éª¤
                completeCurrentStep();
            } else if (data.type === 'system') {
                addSystemMessage(data.message || data.content || '');
                addLog('info', `ç³»ç»Ÿ: ${data.message || data.content}`);
            } else if (data.type === 'error') {
                addErrorMessage(data.error || data.message || '');
                addLog('error', `é”™è¯¯: ${data.error || data.message}`);
            } else if (data.status === 'error') {
                addErrorMessage(data.error);
                addLog('error', `é”™è¯¯: ${data.error}`);
            } else if (data.chunk) {
                // æµå¼å“åº”ç‰‡æ®µ
                updateLastAIMessage(data.full_response || data.chunk);
            } else {
                // å°è¯•æ˜¾ç¤ºå†…å®¹
                if (data.content || data.message || data.text) {
                    addAIMessage(data.content || data.message || data.text);
                }
            }
        }

        // æ·»åŠ  AI æ¶ˆæ¯
        function addAIMessage(content) {
            if (!content) return;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex justify-start';
            msgDiv.innerHTML = `
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-3 rounded-2xl rounded-tl-none shadow-md text-xs leading-relaxed max-w-[90%]">
                    ${escapeHtml(content)}
                </div>
            `;
            chatMessages.appendChild(msgDiv);
            scrollToBottom();
        }

        // æ›´æ–°æœ€åä¸€æ¡ AI æ¶ˆæ¯ï¼ˆç”¨äºæµå¼å“åº”ï¼‰
        function updateLastAIMessage(content) {
            const messages = chatMessages.querySelectorAll('.flex.justify-start');
            if (messages.length > 0) {
                const lastMsg = messages[messages.length - 1];
                const contentDiv = lastMsg.querySelector('div');
                if (contentDiv) {
                    contentDiv.textContent = content;
                }
            } else {
                addAIMessage(content);
            }
            scrollToBottom();
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(content) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex justify-end';
            msgDiv.innerHTML = `
                <div class="bg-slate-200 p-3 rounded-2xl rounded-tr-none shadow text-xs leading-relaxed max-w-[90%]">
                    ${escapeHtml(content)}
                </div>
            `;
            chatMessages.appendChild(msgDiv);
            scrollToBottom();
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(content) {
            if (!content) return;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex justify-center';
            msgDiv.innerHTML = `
                <div class="text-[10px] text-slate-400 bg-slate-50 px-3 py-1.5 rounded-full flex items-center space-x-1">
                    <span>${escapeHtml(content)}</span>
                </div>
            `;
            chatMessages.appendChild(msgDiv);
            scrollToBottom();
        }

        // æ·»åŠ å·¥å…·è°ƒç”¨æ¶ˆæ¯
        function addToolMessage(tool, args) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'space-y-1';
            msgDiv.innerHTML = `
                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">ğŸ”§ Tool Use</div>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 text-xs">
                    <div class="font-bold text-blue-600 mb-1">${escapeHtml(tool)}</div>
                    <div class="text-slate-500 font-mono text-[10px]">${args ? escapeHtml(JSON.stringify(args, null, 2)) : 'æ— å‚æ•°'}</div>
                </div>
            `;
            chatMessages.appendChild(msgDiv);
            scrollToBottom();
        }

        // æ·»åŠ è®¡åˆ’æ¶ˆæ¯
        function addPlanMessage(entries) {
            if (!entries || entries.length === 0) return;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'space-y-1';
            let entriesHtml = entries.map(entry => {
                const icon = entry.status === 'completed' ? 'âœ…' : 'â³';
                return `<div class="flex items-center gap-2 text-xs">
                    <span>${icon}</span>
                    <span class="${entry.status === 'completed' ? 'text-green-600' : 'text-slate-600'}">${escapeHtml(entry.content)}</span>
                </div>`;
            }).join('');

            msgDiv.innerHTML = `
                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">ğŸ“‹ Plan</div>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 text-xs space-y-2">
                    ${entriesHtml}
                </div>
            `;
            chatMessages.appendChild(msgDiv);
            scrollToBottom();
        }

        // æ·»åŠ é”™è¯¯æ¶ˆæ¯
        function addErrorMessage(content) {
            if (!content) return;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'space-y-1';
            msgDiv.innerHTML = `
                <div class="text-[9px] font-bold text-red-400 uppercase tracking-wider">âŒ Error</div>
                <div class="bg-red-50 p-3 rounded-xl border border-red-200 text-xs text-red-700">
                    ${escapeHtml(content)}
                </div>
            `;
            chatMessages.appendChild(msgDiv);
            scrollToBottom();
        }

        // æ¸…ç©ºæ¶ˆæ¯
        function clearMessages() {
            chatMessages.innerHTML = '';
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected, statusMsg = null) {
            if (connected) {
                statusDot.className = 'w-2.5 h-2.5 bg-green-400 rounded-full animate-pulse';
                statusText.textContent = statusMsg || 'å·²è¿æ¥';
                statusText.className = 'text-[10px] text-green-400 font-medium';
            } else {
                statusDot.className = 'w-2.5 h-2.5 bg-amber-400 rounded-full';
                statusText.textContent = statusMsg || 'æœªè¿æ¥';
                statusText.className = 'text-[10px] text-amber-300 font-medium';
            }
        }

        // å¯ç”¨/ç¦ç”¨è¾“å…¥
        function enableInput(enabled) {
            chatInput.disabled = !enabled;
            sendBtn.disabled = !enabled;
            if (enabled) {
                chatInput.placeholder = 'è¾“å…¥æŒ‡ä»¤... (Ctrl+Enter å‘é€)';
                chatInput.classList.remove('bg-slate-100');
            } else {
                chatInput.placeholder = 'ç­‰å¾…è¿æ¥...';
                chatInput.classList.add('bg-slate-100');
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const content = chatInput.value.trim();
            if (!content || !isConnected) return;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addUserMessage(content);
            chatInput.value = '';

            // å‘é€åˆ°æœåŠ¡å™¨
            try {
                ws.send(content);
                console.log('å‘é€æ¶ˆæ¯:', content);
            } catch (error) {
                addErrorMessage('å‘é€å¤±è´¥: ' + error.message);
            }
        }

        // å¿«æ·å‘½ä»¤
        function quickCommand(cmd) {
            chatInput.value = cmd;
            sendMessage();
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ============================================================================
        // æµ‹è¯•æ­¥éª¤çŠ¶æ€ç®¡ç†
        // ============================================================================

        const testSteps = [
            { id: 1, name: 'BIOS Config', status: 'active' },
            { id: 2, name: 'BMC Event Log', status: 'waiting' },
            { id: 3, name: 'OS Power Stress', status: 'waiting' },
            { id: 4, name: 'Topology Verify', status: 'waiting' }
        ];

        let currentStepIndex = 0;

        // æ›´æ–°æ­¥éª¤çŠ¶æ€æ˜¾ç¤º
        function updateStepDisplay() {
            const stepsContainer = document.querySelector('.ml-4.border-l');
            if (!stepsContainer) return;

            stepsContainer.innerHTML = testSteps.map((step, index) => {
                let statusClass = '';
                let statusText = '';
                let activeClass = '';

                switch (step.status) {
                    case 'active':
                        statusClass = 'text-blue-600 font-bold bg-blue-50 border-r-2 border-blue-600';
                        statusText = '<span class="text-[9px] opacity-50 ml-2">Active</span>';
                        activeClass = 'cursor-pointer';
                        break;
                    case 'completed':
                        statusClass = 'text-green-600 bg-green-50 border-r-2 border-green-600';
                        statusText = '<span class="text-[9px] opacity-50 ml-2">âœ“ Done</span>';
                        activeClass = 'cursor-pointer';
                        break;
                    case 'waiting':
                    default:
                        statusClass = 'text-slate-500 hover:bg-slate-50';
                        statusText = '<span class="text-[9px] opacity-50 ml-2 italic">Waiting</span>';
                        activeClass = 'cursor-pointer';
                        break;
                }

                return `<div class="pl-4 py-1 ${statusClass} ${activeClass}" onclick="selectStep(${index})">
                    ${(index + 1).toString().padStart(2, '0')}. ${step.name} ${statusText}
                </div>`;
            }).join('');
        }

        // é€‰æ‹©æ­¥éª¤
        function selectStep(index) {
            currentStepIndex = index;
            // æ›´æ–°å½“å‰æ­¥éª¤ä¸º activeï¼Œå…¶ä»–ä¸º waiting æˆ– completed
            testSteps.forEach((step, i) => {
                if (i === index) {
                    step.status = 'active';
                } else if (i < index) {
                    step.status = 'completed';
                } else {
                    step.status = 'waiting';
                }
            });
            updateStepDisplay();
            addLog('info', `åˆ‡æ¢åˆ°æµ‹è¯•æ­¥éª¤: ${testSteps[index].name}`);
        }

        // å®Œæˆå½“å‰æ­¥éª¤
        function completeCurrentStep() {
            if (currentStepIndex < testSteps.length - 1) {
                testSteps[currentStepIndex].status = 'completed';
                currentStepIndex++;
                testSteps[currentStepIndex].status = 'active';
                updateStepDisplay();
                addLog('success', `å®Œæˆæ­¥éª¤: ${testSteps[currentStepIndex - 1].name}`);
                addLog('info', `å¼€å§‹æ­¥éª¤: ${testSteps[currentStepIndex].name}`);
            } else {
                testSteps[currentStepIndex].status = 'completed';
                updateStepDisplay();
                addLog('success', `æ‰€æœ‰æµ‹è¯•æ­¥éª¤å·²å®Œæˆï¼`);
            }
        }

        // ============================================================================
        // å®æ—¶æ—¥å¿—ç®¡ç†
        // ============================================================================

        const logPanel = document.querySelector('.text-slate-600.leading-loose');
        if (logPanel) {
            // æ¸…ç©ºåˆå§‹æ—¥å¿—
            logPanel.innerHTML = '';
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(type, message) {
            const logPanel = document.querySelector('.text-slate-600.leading-loose');
            if (!logPanel) return;

            const time = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = 'flex space-x-4';

            let timeClass = 'text-blue-500';
            let msgClass = 'text-slate-400';

            switch (type) {
                case 'info':
                    timeClass = 'text-blue-500';
                    msgClass = 'text-slate-400';
                    break;
                case 'success':
                    timeClass = 'text-emerald-500';
                    msgClass = 'text-emerald-600';
                    break;
                case 'warning':
                    timeClass = 'text-yellow-500';
                    msgClass = 'text-yellow-600';
                    break;
                case 'error':
                    timeClass = 'text-red-500';
                    msgClass = 'text-red-600';
                    break;
                case 'command':
                    timeClass = 'text-indigo-500 font-bold';
                    msgClass = 'text-indigo-600';
                    break;
                default:
                    timeClass = 'text-blue-500';
                    msgClass = 'text-slate-400';
            }

            logDiv.innerHTML = `
                <span class="${timeClass}">[${time}]</span>
                <span class="${msgClass}">${escapeHtml(message)}</span>
            `;

            logPanel.appendChild(logDiv);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // åˆå§‹åŒ–æ­¥éª¤æ˜¾ç¤º
        updateStepDisplay();

        // ============================================================================
        // æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
        // ============================================================================

        function submitReport() {
            const timestamp = new Date().toISOString();
            const completedSteps = testSteps.filter(s => s.status === 'completed').length;
            const totalSteps = testSteps.length;
            const completionRate = Math.round((completedSteps / totalSteps) * 100);

            const report = {
                project: 'cTDP_Consistency_Test',
                timestamp: timestamp,
                device: 'Hygon 7002',
                status: completionRate === 100 ? 'PASSED' : (completionRate > 0 ? 'IN_PROGRESS' : 'FAILED'),
                completionRate: completionRate,
                steps: testSteps,
                logs: Array.from(document.querySelectorAll('.text-slate-600.leading-loose div')).map(div => div.textContent)
            };

            // ä¸‹è½½æŠ¥å‘Š
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test_report_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog('success', `æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: ${completionRate}% å®Œæˆ`);
            alert(`æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆï¼\nå®Œæˆç‡: ${completionRate}%\nçŠ¶æ€: ${report.status}`);
        }

        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿æ¥
        window.addEventListener('load', () => {
            connectWebSocket();
        });
    </script>

</body>
</html>