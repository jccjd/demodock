<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIBE Studio - Full IDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; color: #334155; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #475569; }

        /* Markdown æ’ç‰ˆæ ·å¼ */
        .md-prose { font-size: 11px; line-height: 1.6; color: #334155; word-wrap: break-word; }
        .md-prose p { margin-bottom: 0.5rem; }
        .md-prose p:last-child { margin-bottom: 0; }
        .md-prose strong { font-weight: 600; color: #0f172a; }
        .md-prose ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 0.5rem; }
        .md-prose ol { list-style-type: decimal; padding-left: 1.25rem; margin-bottom: 0.5rem; }
        .md-prose li { margin-bottom: 0.25rem; }
        .md-prose code { font-family: 'JetBrains Mono', monospace; background-color: rgba(0,0,0,0.06); padding: 0.1rem 0.25rem; border-radius: 0.25rem; color: #db2777; font-size: 10px; }
        .md-prose pre { background-color: #f1f5f9; padding: 0.75rem; border-radius: 0.375rem; overflow-x: auto; margin-bottom: 0.5rem; border: 1px solid #e2e8f0; }
        .md-prose pre code { background-color: transparent; padding: 0; color: #334155; }
        
        /* æ­¥éª¤å¡ç‰‡æ‰‹é£ç´åŠ¨ç”» */
        .step-details {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out; opacity: 0;
        }
        .step-details.expanded { max-height: 1200px; opacity: 1; overflow-y: auto; }
        .rotate-icon { transition: transform 0.2s; }
        .expanded .rotate-icon { transform: rotate(180deg); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-[13px] bg-slate-50 antialiased">

    <!-- 1. é¡¶éƒ¨çŠ¶æ€æ  -->
    <header class="h-12 border-b border-slate-200 bg-white flex items-center justify-between px-4 shrink-0 z-20 shadow-sm">
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
                <div class="w-7 h-7 bg-blue-600 rounded-md flex items-center justify-center text-white font-bold text-sm shadow-inner">V</div>
                <span class="font-bold text-slate-800 tracking-tight">VIBE STUDIO</span>
            </div>
            <div class="flex items-center space-x-2 text-xs">
                <span class="text-slate-400">Task:</span>
                <span id="header-task-title" class="px-2 py-0.5 bg-slate-100 text-slate-700 rounded font-medium border border-slate-200 truncate max-w-md">cTDP Consistency Test</span>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 px-3 py-1 bg-slate-100 rounded border border-slate-200 shadow-inner">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span id="header-device-ip" class="text-[11px] text-slate-600 font-bold mono">Hygon 7002</span>
            </div>
            <button onclick="submitReport()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-[11px] font-bold shadow-sm hover:bg-blue-700 transition-colors">Submit Report</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- 2. å·¦ä¾§æµ‹è¯•æ­¥éª¤ Explorer -->
        <aside class="w-[340px] border-r border-slate-200 bg-white flex flex-col shrink-0 z-10 shadow-[2px_0_8px_rgba(0,0,0,0.02)]">
            <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                <span class="text-[11px] font-bold text-slate-700 uppercase tracking-widest flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    Execution Steps
                </span>
                <span id="step-count-badge" class="bg-slate-200 text-slate-600 text-[10px] px-1.5 py-0.5 rounded font-bold">4</span>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2.5 bg-slate-50/50" id="test-steps-container"></div>
        </aside>

        <!-- 3. ä¸­éƒ¨å·¥ä½œåŒº (VNC + Terminal) -->
        <main class="flex-1 flex flex-col min-w-[300px] bg-slate-200/80">
            <div class="h-10 flex items-end px-2 pt-2 space-x-1 shrink-0">
                <button id="tab-bios" onclick="switchTab('bios')" class="px-4 py-2 bg-white border border-b-0 border-slate-200 text-[11px] font-bold text-blue-600 rounded-t-lg shadow-sm flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                    BIOS Console
                </button>
                <button id="tab-bmc" onclick="switchTab('bmc')" class="px-4 py-2 bg-slate-100 text-[11px] font-medium text-slate-500 hover:bg-white rounded-t-lg transition-colors flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                    BMC Web
                </button>
            </div>
            <div class="flex-1 p-4 flex flex-col min-h-[40%]">
                <div class="flex-1 bg-[#0f111a] rounded-xl overflow-hidden border border-slate-800 shadow-2xl relative flex items-center justify-center">
                    <!-- BIOS Panel -->
                    <div id="bios-panel" class="w-full h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-900 to-slate-800">
                        <div class="text-center space-y-4">
                            <div class="w-16 h-16 mx-auto bg-slate-700 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-base mb-1">BIOS Console (Serial VNC)</h3>
                                <p class="text-slate-400 text-xs">ä½¿ç”¨ VNC å®¢æˆ·ç«¯è¿æ¥ä»¥ä¸‹åœ°å€</p>
                            </div>
                            <div class="bg-slate-800/80 rounded-lg px-4 py-3 border border-slate-600">
                                <div class="text-slate-400 text-[10px] mb-1">VNC Address</div>
                                <div class="flex items-center justify-center gap-2">
                                    <code id="bios-vnc-addr" class="text-blue-400 text-sm font-mono font-bold">--:5900</code>
                                    <button onclick="copyVncAddr()" class="p-1 hover:bg-slate-700 rounded transition-colors" title="Copy">
                                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- BMC iframe -->
                    <iframe id="bmc-frame" src="" class="w-full h-full border-0 absolute inset-0 z-10 hidden"></iframe>
                </div>
            </div>
            <!-- åº•éƒ¨ Terminal é¢æ¿ -->
            <div class="h-56 bg-[#1e1e2e] flex flex-col shrink-0 border-t border-slate-800 shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
                <div class="flex items-center justify-between px-4 bg-[#181825] h-8 shrink-0">
                    <span class="text-[#89b4fa] text-[10px] font-bold uppercase tracking-wider">System Output Logs</span>
                    <button onclick="clearLogs()" class="text-slate-500 hover:text-white text-[10px] uppercase tracking-wider font-bold transition-colors">Clear</button>
                </div>
                <div id="terminal-output" class="flex-1 overflow-y-auto p-3 terminal-scroll mono text-[12px] leading-relaxed"></div>
            </div>
        </main>

        <!-- 4. å³ä¾§ AI é€šä¿¡åŒº -->
        <aside class="w-96 border-l border-slate-200 bg-white flex flex-col shrink-0 shadow-xl z-10">
            <!-- å¤´éƒ¨çŠ¶æ€ -->
            <div class="px-4 py-3 bg-slate-800 flex items-center justify-between shrink-0">
                <div class="flex items-center space-x-2">
                    <div class="w-6 h-6 rounded bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    </div>
                    <span class="text-white font-bold text-sm tracking-wide">AI Agent Protocol</span>
                </div>
                <div class="flex items-center space-x-1.5 px-2 py-1 bg-black/30 rounded text-[10px]">
                    <span id="ws-dot" class="w-2 h-2 bg-slate-500 rounded-full"></span>
                    <span id="ws-text" class="text-slate-300">Offline</span>
                </div>
            </div>

            <!-- å¿«æ·æŒ‡ä»¤ -->
            <div class="px-4 py-2 bg-white border-b border-slate-100">
                <div class="text-[10px] text-slate-400 font-medium mb-2">Quick Commands:</div>
                <div class="flex flex-wrap gap-1.5">
                    <button onclick="quickCommand('å¸®æˆ‘æ‰“å¼€ç™¾åº¦æœç´¢äººå·¥æ™ºèƒ½')" class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-[10px] font-medium hover:bg-slate-200 transition-colors">æœç´¢</button>
                    <button onclick="quickCommand('åˆ—å‡ºå½“å‰å·¥ä½œç›®å½•çš„æ–‡ä»¶')" class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-[10px] font-medium hover:bg-slate-200 transition-colors">åˆ—æ–‡ä»¶</button>
                    <button onclick="quickCommand('å¸®æˆ‘åˆ†æä»£ç ç»“æ„')" class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-[10px] font-medium hover:bg-slate-200 transition-colors">åˆ†æä»£ç </button>
                </div>
            </div>

            <!-- èŠå¤©è®°å½•å®¹å™¨ -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-slate-50/50">
                <div class="text-center text-[10px] text-slate-400 my-2">Waiting for server connection...</div>
            </div>

            <!-- è¾“å…¥åŒº -->
            <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                <div class="relative flex items-end border border-slate-300 rounded-lg focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-100 transition-all bg-slate-50">
                    <textarea id="chat-input" rows="2" placeholder="Send instruction... (Ctrl+Enter)" class="w-full bg-transparent py-2.5 pl-3 pr-10 text-xs outline-none resize-none disabled:opacity-50" disabled></textarea>
                    <button id="send-btn" onclick="sendMessage()" class="absolute right-2 bottom-2 p-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-slate-300 transition-colors" disabled>
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- ========================================== -->
    <!-- ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘å¼•æ“ -->
    <!-- ========================================== -->
    <script>
        // é…ç½®ä¸­å¿ƒ
        const HOST = window.location.hostname || 'localhost';
        const AppConfig = {
            WS_URL: `ws://${HOST}:8082/ws`,
            HEALTH_URL: `http://${HOST}:8082/health`,
            VNC_BMC_URL: `http://${HOST}:3000/vnc/index.html?autoconnect=true`,
            BIOS_VNC_ADDR: `${HOST}:5900`
        };

        // åˆå§‹åŒ– marked é€‰é¡¹
        marked.setOptions({ gfm: true, breaks: true });

        // æµ‹è¯•æ­¥éª¤æ•°æ®
        const testSteps = [
            {
                step_id: 1,
                step_number: 1,
                description: "è¿›å…¥ BIOS Setupï¼Œå¯¼èˆªè‡³ä»¥ä¸‹è·¯å¾„ï¼š\n\n**CBS â†’ NBIO â†’ cTDP Control**\n\nå°†æ¨¡å¼è®¾ç½®ä¸º `Manual`ï¼Œç›®æ ‡åŠŸç‡è®¾ç½®ä¸º `280W`ã€‚",
                expected_result: "cTDP é…ç½®æˆåŠŸä¿å­˜ï¼Œé‡å¯åç”Ÿæ•ˆ",
                actual_result: "",
                status: "1" // Running
            },
            {
                step_id: 2,
                step_number: 2,
                description: "é€šè¿‡ BMC Web ç•Œé¢æ£€æŸ¥ç³»ç»Ÿäº‹ä»¶æ—¥å¿—ï¼š\n\n1. ç™»å½• BMC Web æ§åˆ¶å°\n2. å¯¼èˆªè‡³ **Server Health â†’ Event Log**\n3. ç¡®è®¤æ— ç¡¬ä»¶å‘Šè­¦",
                expected_result: "æ—  Critical æˆ– Warning çº§åˆ«äº‹ä»¶",
                actual_result: "",
                status: "0" // Waiting
            },
            {
                step_id: 3,
                step_number: 3,
                description: "åœ¨ OS ä¸‹æ‰§è¡Œå‹åŠ›æµ‹è¯•ï¼š\n\n```bash\nstress-ng --cpu 64 --timeout 3600s\n```\n\nç›‘æ§ CPU é¢‘ç‡å’ŒåŠŸè€—å˜åŒ–ã€‚",
                expected_result: "CPU é¢‘ç‡ç¨³å®šï¼ŒåŠŸè€—æ¥è¿‘ cTDP è®¾å®šå€¼",
                actual_result: "",
                status: "0"
            },
            {
                step_id: 4,
                step_number: 4,
                description: "éªŒè¯ç³»ç»Ÿæ‹“æ‰‘ç»“æ„ï¼š\n\n```bash\nlscpu\nlstopo\n```\n\nç¡®è®¤ NUMA èŠ‚ç‚¹å’Œ CPU æ‹“æ‰‘æ­£ç¡®ã€‚",
                expected_result: "æ‹“æ‰‘ç»“æ„ä¸é¢„æœŸä¸€è‡´",
                actual_result: "",
                status: "0"
            }
        ];

        // WebSocket ç›¸å…³å˜é‡
        let ws = null;
        let isConnected = false;

        // DOM å…ƒç´ å¼•ç”¨
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const terminalOutput = document.getElementById('terminal-output');

        // ==========================================
        // Tab åˆ‡æ¢
        // ==========================================
        function switchTab(tabId) {
            const tabBios = document.getElementById('tab-bios');
            const tabBmc = document.getElementById('tab-bmc');
            const biosPanel = document.getElementById('bios-panel');
            const bmcFrame = document.getElementById('bmc-frame');
            
            const activeCls = "px-4 py-2 bg-white border border-b-0 border-slate-200 text-[11px] font-bold text-blue-600 rounded-t-lg shadow-sm flex items-center gap-2";
            const inactiveCls = "px-4 py-2 bg-slate-100 text-[11px] font-medium text-slate-500 hover:bg-white rounded-t-lg transition-colors flex items-center gap-2";

            if (tabId === 'bios') {
                tabBios.className = activeCls;
                tabBmc.className = inactiveCls;
                biosPanel.classList.remove('hidden');
                bmcFrame.classList.add('hidden');
                addLog('info', 'Switched to BIOS Console');
            } else {
                tabBmc.className = activeCls;
                tabBios.className = inactiveCls;
                biosPanel.classList.add('hidden');
                bmcFrame.classList.remove('hidden');
                if (!bmcFrame.src || bmcFrame.src === '' || bmcFrame.src === window.location.href) {
                    bmcFrame.src = AppConfig.VNC_BMC_URL;
                }
                addLog('info', 'Switched to BMC Web Console');
            }
        }

        // ==========================================
        // æµ‹è¯•æ­¥éª¤ç®¡ç† (æ‰‹é£ç´å¼)
        // ==========================================
        function renderTestSteps() {
            const container = document.getElementById('test-steps-container');
            container.innerHTML = '';
            
            const statusMap = {
                "0": { text: "Waiting", border: "border-slate-200", bg: "bg-white", badge: "bg-slate-100 text-slate-500", icon: "â³" },
                "1": { text: "Running", border: "border-blue-400", bg: "bg-blue-50/50", badge: "bg-blue-100 text-blue-700", icon: "ğŸ”„" },
                "2": { text: "Failed", border: "border-red-300", bg: "bg-red-50/50", badge: "bg-red-100 text-red-700", icon: "âŒ" },
                "3": { text: "Pass", border: "border-emerald-300", bg: "bg-emerald-50/30", badge: "bg-emerald-100 text-emerald-700", icon: "âœ…" }
            };

            testSteps.forEach((step, index) => {
                const statusObj = statusMap[step.status] || statusMap["0"];
                const htmlDesc = marked.parse(step.description || 'æ— æè¿°');
                const htmlExpected = marked.parse(step.expected_result || 'æ— é¢„æœŸç»“æœ');
                const htmlActual = step.actual_result ? marked.parse(step.actual_result) : null;
                const isExpanded = step.status === "1" ? 'expanded' : '';
                const hasShadow = step.status === "1" ? 'shadow-md' : '';

                container.innerHTML += `
                    <div class="mb-3 rounded-lg border ${statusObj.border} ${statusObj.bg} transition-shadow duration-300 ${hasShadow} bg-white">
                        <div class="px-3 py-2.5 cursor-pointer flex flex-col gap-1.5 select-none" onclick="toggleStep(this)">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-[12px] text-slate-800 flex items-center gap-1.5">
                                    <span>${statusObj.icon}</span> 
                                    Step ${step.step_number}
                                </span>
                                <div class="flex items-center gap-2">
                                    <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${statusObj.badge}">${statusObj.text}</span>
                                    <svg class="w-4 h-4 text-slate-400 rotate-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                            <div class="text-[11px] text-slate-500 truncate pr-6">${step.description.split('\n')[0].substring(0, 50)}...</div>
                        </div>
                        <div class="step-details ${isExpanded} border-t border-slate-100/80 bg-slate-50/30 rounded-b-lg custom-scrollbar">
                            <div class="p-4 flex flex-col gap-4">
                                <div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                                        Description
                                    </div>
                                    <div class="md-prose">${htmlDesc}</div>
                                </div>
                                <div class="pt-3 border-t border-slate-200 border-dashed">
                                    <div class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1.5 flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        Expected
                                    </div>
                                    <div class="md-prose">${htmlExpected}</div>
                                </div>
                                ${htmlActual ? `
                                <div class="pt-3 border-t border-slate-200 border-dashed">
                                    <div class="text-[10px] font-bold ${step.status === '2' ? 'text-red-500' : 'text-emerald-500'} uppercase tracking-wider mb-1.5">Actual Result</div>
                                    <div class="md-prose ${step.status === '2' ? 'text-red-700 bg-red-50/50 p-2 rounded border border-red-100' : ''}">${htmlActual}</div>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        }

        function toggleStep(element) {
            const detailsDiv = element.nextElementSibling;
            const wrapperDiv = element.parentElement;
            if (detailsDiv.classList.contains('expanded')) {
                detailsDiv.classList.remove('expanded');
                wrapperDiv.classList.remove('shadow-md');
            } else {
                document.querySelectorAll('.step-details.expanded').forEach(el => {
                    el.classList.remove('expanded');
                    el.parentElement.classList.remove('shadow-md');
                });
                detailsDiv.classList.add('expanded');
                wrapperDiv.classList.add('shadow-md');
            }
        }

        // ==========================================
        // Terminal æ—¥å¿—
        // ==========================================
        function addLog(type, message) {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const div = document.createElement('div');
            div.className = 'flex space-x-3 mb-1 hover:bg-white/5 px-1 rounded';
            let color = type === 'error' ? 'text-[#ef5350]' : (type === 'success' ? 'text-[#addb67]' : (type === 'cmd' ? 'text-[#82aaff]' : 'text-[#a6accd]'));
            let prefix = type === 'error' ? '[ERROR]' : (type === 'success' ? '[SUCCESS]' : (type === 'cmd' ? '[EXEC]' : '[INFO]'));
            div.innerHTML = `<span class="text-[#4d5566] shrink-0">[${time}]</span> <span class="${color} shrink-0">${prefix}</span> <span class="text-[#a6accd] whitespace-pre-wrap break-words">${escapeHtml(message)}</span>`;
            terminalOutput.appendChild(div);
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        function clearLogs() {
            terminalOutput.innerHTML = '';
            addLog('info', 'Logs cleared');
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        // ==========================================
        // WebSocket é€šä¿¡
        // ==========================================
        async function connectWebSocket() {
            // å…ˆæ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
            try {
                const response = await fetch(AppConfig.HEALTH_URL, { method: 'GET' });
                if (!response.ok) {
                    showServiceDependencyInfo();
                    setTimeout(connectWebSocket, 5000);
                    return;
                }
            } catch (e) {
                showServiceDependencyInfo();
                setTimeout(connectWebSocket, 5000);
                return;
            }

            updateStatus('connecting');
            addLog('info', `Connecting to ${AppConfig.WS_URL}...`);

            try {
                ws = new WebSocket(AppConfig.WS_URL);
                
                ws.onopen = () => {
                    isConnected = true;
                    updateStatus('connected');
                    chatMessages.innerHTML = '';
                    addMessage('system', 'âœ… Connected to iFlow Browser Server');
                    addLog('success', 'WebSocket connected');
                };

                ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        handleMessage(data);
                    } catch (err) {
                        addMessage('ai', e.data);
                    }
                };

                ws.onclose = () => {
                    isConnected = false;
                    updateStatus('offline');
                    addMessage('system', 'âš ï¸ Connection closed');
                    addLog('info', 'WebSocket disconnected, reconnecting...');
                    setTimeout(connectWebSocket, 5000);
                };

                ws.onerror = () => {
                    updateStatus('offline');
                    addLog('error', 'WebSocket error');
                };

            } catch (err) {
                updateStatus('offline');
                addLog('error', 'Connection failed: ' + err.message);
                setTimeout(connectWebSocket, 5000);
            }
        }

        function updateStatus(state) {
            const dot = document.getElementById('ws-dot');
            const text = document.getElementById('ws-text');
            
            if (state === 'connected') {
                dot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#22c55e]';
                text.textContent = 'Connected';
                chatInput.disabled = sendBtn.disabled = false;
            } else if (state === 'connecting') {
                dot.className = 'w-2 h-2 bg-yellow-500 rounded-full';
                text.textContent = 'Connecting...';
            } else {
                dot.className = 'w-2 h-2 bg-red-500 rounded-full';
                text.textContent = 'Offline';
                chatInput.disabled = sendBtn.disabled = true;
            }
        }

        function showServiceDependencyInfo() {
            chatMessages.innerHTML = `
                <div class="space-y-2 text-xs">
                    <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">ğŸ“‹ æœåŠ¡ä¾èµ–</div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 space-y-2">
                        <div class="text-slate-600">
                            <div class="font-medium mb-1">éœ€è¦å¯åŠ¨ä»¥ä¸‹æœåŠ¡ï¼š</div>
                            <div class="font-mono text-[10px] space-y-1 ml-2">
                                <div class="text-slate-500">1. iFlow ACP Server:</div>
                                <div class="text-blue-600 bg-blue-50 px-2 py-1 rounded">iflow --experimental-acp --port 8090</div>
                                <div class="text-slate-500 mt-2">2. Browser Server:</div>
                                <div class="text-blue-600 bg-blue-50 px-2 py-1 rounded">uv run python src/server.py</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function handleMessage(data) {
            console.log('Received message:', data);
            
            if (data.type === 'tool_use') {
                addMessage('tool', `ğŸ”§ **${data.tool}**\n\`\`\`json\n${JSON.stringify(data.args, null, 2)}\n\`\`\``);
                addLog('cmd', `Tool: ${data.tool}`);
            } else if (data.type === 'task_finish') {
                // é‡ç½®æµå¼çŠ¶æ€
                isStreaming = false;
                const streamingMsg = chatMessages.querySelector('.streaming-message');
                if (streamingMsg) {
                    streamingMsg.classList.remove('streaming-message');
                }
                addLog('success', 'Task finished: ' + data.stop_reason);
                // æ ‡è®°å½“å‰æ­¥éª¤å®Œæˆ
                advanceStep();
            } else if (data.type === 'assistant' || data.type === 'stream' || data.status === 'streaming') {
                // å¤„ç†æµå¼å“åº”
                const content = data.full_response || data.chunk || data.content || '';
                if (content) {
                    updateOrCreateAIMessage(content);
                }
            } else if (data.chunk || data.full_response) {
                // å…¼å®¹å…¶ä»–æ ¼å¼çš„æµå¼å“åº”
                updateOrCreateAIMessage(data.full_response || data.chunk);
            } else if (data.content || data.message) {
                addMessage('ai', data.content || data.message);
            } else if (data.type === 'error') {
                addMessage('system', 'âŒ Error: ' + (data.error || data.message));
                addLog('error', data.error || data.message);
            }
        }

        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !isConnected) return;
            
            addMessage('user', text);
            chatInput.value = '';
            addLog('info', `User: ${text}`);
            
            try {
                ws.send(text);
            } catch (e) {
                addMessage('system', 'Failed to send message');
            }
        }

        function quickCommand(cmd) {
            chatInput.value = cmd;
            sendMessage();
        }

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            
            let innerHTML = '';
            if (role === 'user') {
                innerHTML = `<div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-sm shadow-md text-xs leading-relaxed max-w-[85%] whitespace-pre-wrap">${escapeHtml(content)}</div>`;
            } else if (role === 'system') {
                innerHTML = `<div class="w-full text-center my-1"><span class="text-[10px] text-slate-400 bg-white/50 border border-slate-200 px-3 py-1 rounded-full shadow-sm">${escapeHtml(content)}</span></div>`;
            } else if (role === 'tool') {
                const parsedHtml = marked.parse(content);
                innerHTML = `
                    <div class="flex flex-col max-w-[90%]">
                        <div class="bg-slate-100 border-slate-200 text-slate-600 border p-3 rounded-xl shadow-sm text-xs leading-relaxed">
                            <div class="md-prose">${parsedHtml}</div>
                        </div>
                    </div>`;
            } else {
                const parsedHtml = marked.parse(content);
                innerHTML = `
                    <div class="flex flex-col max-w-[90%]">
                        <span class="text-[10px] font-bold text-slate-400 ml-1 mb-1">AI Agent</span>
                        <div class="bg-white border-slate-200 text-slate-700 border p-3 rounded-2xl rounded-tl-sm shadow-sm text-xs leading-relaxed">
                            <div class="md-prose">${parsedHtml}</div>
                        </div>
                    </div>`;
            }

            div.innerHTML = innerHTML;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æµå¼æ¶ˆæ¯å¤„ç†ï¼šæ›´æ–°æˆ–åˆ›å»º AI æ¶ˆæ¯
        let isStreaming = false;
        
        function updateOrCreateAIMessage(content) {
            // æŸ¥æ‰¾æœ€åä¸€æ¡æ­£åœ¨æµå¼ä¼ è¾“çš„ AI æ¶ˆæ¯
            const streamingMsg = chatMessages.querySelector('.streaming-message');
            
            if (streamingMsg && isStreaming) {
                // æ›´æ–°ç°æœ‰æ¶ˆæ¯
                const proseDiv = streamingMsg.querySelector('.md-prose');
                if (proseDiv) {
                    proseDiv.innerHTML = marked.parse(content);
                }
            } else {
                // åˆ›å»ºæ–°çš„æµå¼æ¶ˆæ¯
                isStreaming = true;
                const div = document.createElement('div');
                div.className = 'flex justify-start w-full';
                div.innerHTML = `
                    <div class="flex flex-col max-w-[90%] streaming-message">
                        <span class="text-[10px] font-bold text-slate-400 ml-1 mb-1">AI Agent</span>
                        <div class="bg-white border-slate-200 text-slate-700 border p-3 rounded-2xl rounded-tl-sm shadow-sm text-xs leading-relaxed">
                            <div class="md-prose">${marked.parse(content)}</div>
                        </div>
                    </div>`;
                chatMessages.appendChild(div);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateLastAIMessage(content) {
            // å…¼å®¹æ—§è°ƒç”¨ï¼Œé‡å®šå‘åˆ°æ–°å‡½æ•°
            updateOrCreateAIMessage(content);
        }

        // ==========================================
        // æ­¥éª¤æ¨è¿›
        // ==========================================
        function advanceStep() {
            const currentIdx = testSteps.findIndex(s => s.status === "1");
            if (currentIdx >= 0) {
                testSteps[currentIdx].status = "3"; // Pass
                if (currentIdx < testSteps.length - 1) {
                    testSteps[currentIdx + 1].status = "1"; // Running
                    addLog('info', `Advancing to Step ${currentIdx + 2}`);
                }
                renderTestSteps();
            }
        }

        // ==========================================
        // æŠ¥å‘Šç”Ÿæˆ
        // ==========================================
        function submitReport() {
            const completed = testSteps.filter(s => s.status === "3").length;
            const rate = Math.round((completed / testSteps.length) * 100);
            
            const report = {
                project: 'cTDP Consistency Test',
                timestamp: new Date().toISOString(),
                device: 'Hygon 7002',
                completionRate: rate,
                status: rate === 100 ? 'PASSED' : (rate > 0 ? 'IN_PROGRESS' : 'FAILED'),
                steps: testSteps
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test_report_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('success', `Report generated: ${rate}% complete`);
        }

        // ==========================================
        // VNC åœ°å€å¤åˆ¶
        // ==========================================
        function copyVncAddr() {
            navigator.clipboard.writeText(AppConfig.BIOS_VNC_ADDR).then(() => {
                addLog('success', `Copied: ${AppConfig.BIOS_VNC_ADDR}`);
            });
        }

        // ==========================================
        // åˆå§‹åŒ–
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½® VNC åœ°å€æ˜¾ç¤º
            document.getElementById('bios-vnc-addr').textContent = AppConfig.BIOS_VNC_ADDR;
            
            // æ¸²æŸ“æµ‹è¯•æ­¥éª¤
            renderTestSteps();
            
            // è®¾ç½®é»˜è®¤ Tab
            switchTab('bios');
            
            // è¿æ¥ WebSocket
            setTimeout(connectWebSocket, 500);
        });

        // å¿«æ·é”®
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
