<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Browserless 实时预览 (Sessions版)</title>
    <style>
        body { margin: 0; padding: 0; background: #121212; color: #eee; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        .header { width: 100%; background: #1f1f1f; padding: 12px 25px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .status { font-size: 13px; padding: 4px 10px; border-radius: 4px; background: #444; }
        .online { background: #28a745; color: white; }
        .container { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        #browser-screen { max-width: 100%; max-height: 100%; border: 1px solid #333; box-shadow: 0 0 30px rgba(0,0,0,0.7); cursor: crosshair; user-select: none; -webkit-user-drag: none; }
        #msg { color: #888; font-size: 14px; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-weight: bold; letter-spacing: 1px;">BROWSER PREVIEW</div>
    <div id="status-tag" class="status">正在搜索会话...</div>
</div>

<div class="container">
    <div id="msg">等待 Python 脚本启动并打开网页...</div>
    <img id="browser-screen" src="" style="display: none;">
</div>

<script>
    // ======= 修改这里为你服务器的实际 IP =======
    const SERVER_IP = "10.8.135.251";
    const SERVER_PORT = "3000";
    // =========================================

    const screenImg = document.getElementById('browser-screen');
    const msgDiv = document.getElementById('msg');
    const statusTag = document.getElementById('status-tag');
    let ws = null;

    // 1. 获取会话并寻找页面 ID
    async function findPageAndConnect() {
        try {
            const response = await fetch(`http://${SERVER_IP}:${SERVER_PORT}/sessions`);
            const sessions = await response.json();

            // 在列表中寻找类型为 page 且不是空白页的对象
            const target = sessions.find(s => s.type === 'page' && s.url !== 'about:blank') 
                         || sessions.find(s => s.type === 'page');

            if (!target) {
                msgDiv.innerText = "未发现活动页面。请运行 Python 脚本打开百度...";
                setTimeout(findPageAndConnect, 2000);
                return;
            }

            console.log("成功发现页面 ID:", target.id);
            startStreaming(target.id);
        } catch (err) {
            msgDiv.innerText = "无法连接到服务器。请检查 IP 和 Browserless 状态。";
            setTimeout(findPageAndConnect, 5000);
        }
    }

    // 2. 建立截图流连接
    function startStreaming(pageId) {
        if (ws) ws.close();
        
        const wsUrl = `ws://${SERVER_IP}:${SERVER_PORT}/devtools/page/${pageId}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            msgDiv.style.display = 'none';
            screenImg.style.display = 'block';
            statusTag.innerText = "已连接 - 实时直播";
            statusTag.classList.add('online');

            // 初始化 CDP 指令
            ws.send(JSON.stringify({ id: 1, method: "Page.enable" }));
            ws.send(JSON.stringify({
                id: 2,
                method: "Page.startScreencast",
                params: { format: "jpeg", quality: 80, everyNthFrame: 1 }
            }));
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.method === "Page.screencastFrame") {
                // 渲染图片
                screenImg.src = "data:image/jpeg;base64," + data.params.data;
                // 回复确认以获取下一帧
                ws.send(JSON.stringify({
                    method: "Page.screencastFrameAck",
                    params: { sessionId: data.params.sessionId }
                }));
            }
        };

        ws.onclose = () => {
            statusTag.innerText = "连接断开";
            statusTag.classList.remove('online');
            screenImg.style.display = 'none';
            msgDiv.style.display = 'block';
            setTimeout(findPageAndConnect, 2000);
        };
    }

    // 3. 点击交互支持
    screenImg.addEventListener('mousedown', (e) => {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        const rect = screenImg.getBoundingClientRect();
        const x = Math.round((e.clientX - rect.left) * (screenImg.naturalWidth / rect.width));
        const y = Math.round((e.clientY - rect.top) * (screenImg.naturalHeight / rect.height));

        const sendMouse = (type) => ws.send(JSON.stringify({
            id: 10,
            method: "Input.dispatchMouseEvent",
            params: { type, x, y, button: "left", clickCount: 1 }
        }));

        sendMouse("mousePressed");
        setTimeout(() => sendMouse("mouseReleased"), 100);
    });

    // 开始执行
    findPageAndConnect();
</script>

</body>
</html>